{"version":3,"file":"sandbox.js","sources":["webpack://aero-sandbox/./build/AeroSandboxBuilder.ts","webpack://aero-sandbox/./build/customBuilds/aero.ts","webpack://aero-sandbox/./build/customBuilds/frankenUV.inject.ts","webpack://aero-sandbox/./build/featureMembers.ts","webpack://aero-sandbox/./src/interceptors/concealer/blob.ts","webpack://aero-sandbox/./src/interceptors/concealer/css.ts","webpack://aero-sandbox/./src/interceptors/concealer/error.ts","webpack://aero-sandbox/./src/interceptors/concealer/file.ts","webpack://aero-sandbox/./src/interceptors/concealer/launchQueue.ts","webpack://aero-sandbox/./src/interceptors/concealer/misc/scriptSandboxing.ts","webpack://aero-sandbox/./src/interceptors/concealer/moduleScripts.ts","webpack://aero-sandbox/./src/interceptors/concealer/navigation.ts","webpack://aero-sandbox/./src/interceptors/concealer/payment.ts","webpack://aero-sandbox/./src/interceptors/concealer/presentation.ts","webpack://aero-sandbox/./src/interceptors/concealer/push.ts","webpack://aero-sandbox/./src/interceptors/concealer/reporting.ts","webpack://aero-sandbox/./src/interceptors/concealer/secure.ts","webpack://aero-sandbox/./src/interceptors/concealer/timing.ts","webpack://aero-sandbox/./src/interceptors/concealer/xml.ts","webpack://aero-sandbox/./src/interceptors/event/messages.ts","webpack://aero-sandbox/./src/interceptors/externalResourceLoc/contentIndex.ts","webpack://aero-sandbox/./src/interceptors/externalResourceLoc/share.ts","webpack://aero-sandbox/./src/interceptors/loc/history.ts","webpack://aero-sandbox/./src/interceptors/loc/location.ts","webpack://aero-sandbox/./src/interceptors/loc/navigator.ts","webpack://aero-sandbox/./src/interceptors/loc/open.ts","webpack://aero-sandbox/./src/interceptors/originIsolators/privacySandbox/credentials.ts","webpack://aero-sandbox/./src/interceptors/req/eventSource.ts","webpack://aero-sandbox/./src/interceptors/req/fetch.ts","webpack://aero-sandbox/./src/interceptors/req/wrtc.ts","webpack://aero-sandbox/./src/interceptors/req/ws.ts","webpack://aero-sandbox/./src/interceptors/req/wt.ts","webpack://aero-sandbox/./src/interceptors/storage/cookie.ts","webpack://aero-sandbox/./src/interceptors/storage/fs.ts","webpack://aero-sandbox/./src/interceptors/storage/iDB.ts","webpack://aero-sandbox/./src/interceptors/storage/sharedStorage.ts","webpack://aero-sandbox/./src/interceptors/storage/storage.ts","webpack://aero-sandbox/./src/interceptors/worker/workers.ts","webpack://aero-sandbox/./src/shared/escape.ts","webpack://aero-sandbox/./src/shared/getProxyUrl.ts","webpack://aero-sandbox/./src/shared/isHTML.ts","webpack://aero-sandbox/./src/shared/proxyLocation.ts","webpack://aero-sandbox/./src/shared/sharedConfig.ts","webpack://aero-sandbox/./src/shared/src.ts","webpack://aero-sandbox/./src/shared/stringProxy.ts","webpack://aero-sandbox/../../node_modules/@mercuryworkshop/bare-mux/dist/index.mjs","webpack://aero-sandbox/./build/init.ts"],"sourcesContent":["import type { AeroSandboxConfig } from \"../types/aeroSandbox\";\n\nexport default class AeroSandbox {\n\tconfig: AeroSandboxConfig;\n\tfakeOrigin(\n\t\tapiIncludeBitwiseEnum: APIBitwiseEnum | \"all\",\n\t\tapiExcludeBitwiseEnum: APIBitwiseEnum | \"none\",\n\t\trewriterModesBitwiseEnum: rewriterModesBitwiseEnum,\n\t\tisWorker = false,\n\t\tproxyOrigin: string\n\t): ResultAsync<boolean> {}\n\t/** This API isn't implemented yet and is here to serve as a placeholder */\n\tfaker: {};\n\trewriters;\n}\n","import { defaultSWProxyFeatures } from \"../featureMembers\";\n\nimport AeroSandbox from \"../AeroSandboxBuilder\";\n\nconst buildConfig = {\n\tproxyConfig: {\n\t\t...self.config\n\t},\n\tspecialInterceptionFeatures: defaultSWProxyFeatures\n};\n\nconst fakeOriginSettings = [\"all\", \"all\", \"none\"];\n\nexport { buildConfig, fakeOriginSettings };\n\nexport default new AeroSandbox(buildConfig).fakeOrigin(...fakeOriginSettings);\n","import type { UVConfig } from \"@titaniumnetwork-dev/ultraviolet\";\n\nimport { defaultProxyFeatures } from \"../featureMembers\";\n\nimport AeroSandbox from \"../AeroSandboxBuilder\";\n\nenum UVRewriterMembers {}\n\nlet __uv$config: UVConfig;\n\nconst buildConfig = {\n\tproxyConfig: {\n\t\tencodeUrl: __uv$config.encodeUrl,\n\t\tdecodeUrl: __uv$config.decodeUrl\n\t},\n\tspecialInterceptionFeatures: defaultProxyFeatures\n};\n\nconst fakeOriginSettings = [\"all\", UVRewriterMembers, \"none\"];\n\nexport default new AeroSandbox(buildConfig).fakeOrigin(...fakeOriginSettings);\n","import { InterceptionFeaturesEnum } from \"$types/apiInterceptors\";\n\n// TODO: Put all of these terms in the API Interception Glossary\n\n/** @note: These do not cover Origin Isolation although Origin Emulation is a type of Origin Isolation. Origin Emulation is a superset of Origin Isolation. */\nconst originEmulationFeatures =\n\tInterceptionFeaturesEnum.corsEmulation |\n\tInterceptionFeaturesEnum.cacheEmulation |\n\tInterceptionFeaturesEnum.privacySandbox |\n\tInterceptionFeaturesEnum.nestedSWs;\n/** @note: These do not cover Origin Concealers although Origin Isolation is a type of Origin Concealing. Origin Isolation is a superset of Origin Concealment. */\nconst miscOriginIsolators = InterceptionFeaturesEnum.messageIsolation;\nconst miscOriginConcealers =\n\tInterceptionFeaturesEnum.elementConcealment |\n\tInterceptionFeaturesEnum.errorConcealment;\nconst defaultSWProxyFeatures = originEmulationFeatures | miscOriginConcealers;\nconst defaultProxyFeatures =\n\tdefaultSWProxyFeatures | InterceptionFeaturesEnum.requestUrlProxifier;\n\nexport {\n\toriginEmulationFeatures,\n\tmiscOriginIsolators,\n\tmiscOriginConcealers,\n\tdefaultSWProxyFeatures,\n\tdefaultProxyFeatures\n};\n","import type { APIInterceptor } from \"$types/apiInterceptors\";\nimport isHtml from \"$shared/isHTML\";\n\nexport default {\n\tproxifiedObj: Proxy.revocable(Blob, {\n\t\tapply(target, that, args) {\n\t\t\tconst [arr, opts] = args;\n\n\t\t\tif (isHtml(opts.type))\n\t\t\t\targs[0] = arr.map((html: string) => $aero.init + html);\n\n\t\t\tconst ret = Reflect.apply(target, that, args);\n\n\t\t\tlet size = 0;\n\n\t\t\targs[0].forEach((html: string) => (size += html.length));\n\n\t\t\tret.size = size;\n\n\t\t\treturn ret;\n\t\t}\n\t}),\n\tglobalProp: \"Blob\"\n} as APIInterceptor;\n","/** Concealers for methods that return `CSSStyleSheet` (shadow root stylesheets)\n * This file should be required into a bundle for AeroSandbox, so there are no exports\n *\n * @see {@link https://drafts.csswg.org/cssom/#dom-documentorshadowroot-stylesheets}\n * @see {@link https://developer.mozilla.org/en-US/docs/Web/API/CSSStyleSheet#obtaining_a_stylesheet} - These explain all of the methods of obtaining `CSSStyleSheet`. TODO: Finish intercepting all of those revealers.\n */\n\nimport { afterPrefix } from \"$shared/getProxyUrl\";\nimport {\n\ttype APIInterceptor,\n\tExposedContextsEnum\n} from \"$types/apiInterceptors\";\n\n// Proxy the getters for shadow root stylesheets\n\nfunction getSheet(sheet: CSSStyleSheet): CSSStyleSheet {\n\treturn new Proxy(sheet, {\n\t\tget(target, prop: keyof CSSStyleSheet) {\n\t\t\tif (prop === \"href\") {\n\t\t\t\treturn afterPrefix(target.href);\n\t\t\t} else if (prop === \"parentStyleSheet\") {\n\t\t\t\t// Parent recursion\n\t\t\t\tconst parentStyleSheet = target.parentStyleSheet;\n\t\t\t\tif (parentStyleSheet !== null)\n\t\t\t\t\treturn getSheet(parentStyleSheet);\n\t\t\t}\n\t\t\treturn target[prop];\n\t\t}\n\t});\n}\n\n// TODO: Inside of .xsl files spoof the conceal processing instructions nodes to hide their stylesheets\nfunction getProcessingInstructionSheet(\n\tprocessingInstruction: ProcessingInstruction\n): ProcessingInstruction {\n\treturn new Proxy(processingInstruction, {\n\t\tget(target, prop: keyof ProcessingInstruction) {\n\t\t\tif (prop === \"sheet\") {\n\t\t\t\tconst sheet = target.sheet;\n\t\t\t\tif (sheet !== null) return getSheet(sheet);\n\t\t\t}\n\t\t\treturn target[prop];\n\t\t}\n\t});\n}\n\nexport default {\n\tmodifyObjectProperty: () =>\n\t\tObject.defineProperty(document, \"styleSheets\", {\n\t\t\tget: () => {\n\t\t\t\t// Conceal each `CSSStyleSheet` from the `StyleSheetList`\n\t\t\t\tconst ret = Array.from(document.styleSheets).map(getSheet);\n\n\t\t\t\treturn ret;\n\t\t\t}\n\t\t}),\n\tglobalProp: \"document.styleSheets\",\n\texposedContexts: ExposedContextsEnum.window\n} as APIInterceptor;\n","import { type APIInterceptor, SupportEnum } from \"$types/apiInterceptors\";\n\nimport { afterPrefix } from \"$shared/getProxyUrl\";\n\n/*\nError emulation\nThese properties are not standard, so functionality is different in browsers\nThese interceptors will probably change a lot over time\n*/\nexport default {\n\tproxifiedObj: Proxy.revocable(Error, {\n\t\tconstruct(target, args) {\n\t\t\tconst res = Reflect.construct(target, args);\n\n\t\t\t// Firefox exclusives\n\t\t\t// Error location\n\t\t\tif (typeof res.columnNumber !== \"undefined\")\n\t\t\t\t// TODO: Get the column number of the unscoped file\n\t\t\t\t// Possibly, add a data attribute with the original script\n\t\t\t\tres.columnNumber = \"\";\n\t\t\tif (typeof res.fileName !== \"undefined\")\n\t\t\t\tres.fileName = afterPrefix(res.fileName);\n\n\t\t\t// Implemented in most major browsers\n\t\t\tif (typeof res.stack !== \"undefined\")\n\t\t\t\tif (navigator.userAgent.includes(\"Firefox\")) {\n\t\t\t\t\tconst match = /Firefox\\/([\\d\\.]+)/g.exec(\n\t\t\t\t\t\tnavigator.userAgent\n\t\t\t\t\t);\n\n\t\t\t\t\tif (match !== null && match.length === 2) {\n\t\t\t\t\t\tconst ver = Number.parseFloat(match[1]);\n\n\t\t\t\t\t\tres.stack = res.stack.replace(\n\t\t\t\t\t\t\tnew RegExp(\n\t\t\t\t\t\t\t\t`^(@)(.+)(\\\\d+${ver >= 30 ? \":\\\\d+\" : \"\"})$`,\n\t\t\t\t\t\t\t\t\"g\"\n\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t(_match, g1, g2, g3) => g1 + afterPrefix(g2) + g3\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t} else if (navigator.userAgent.includes(\"Chrome\"))\n\t\t\t\t\tres.stack = res.stack\n\t\t\t\t\t\t.split(\"\\n\")\n\t\t\t\t\t\t.map(line =>\n\t\t\t\t\t\t\tline.includes(location.origin /*+ config.prefix*/)\n\t\t\t\t\t\t\t\t? \"\"\n\t\t\t\t\t\t\t\t: line\n\t\t\t\t\t\t)\n\t\t\t\t\t\t.join(\"\\n\")\n\t\t\t\t\t\t.replace(\n\t\t\t\t\t\t\t/^(at )([A-Za-z\\.]+ )?.+(?=:\\d+:\\d+)/g,\n\t\t\t\t\t\t\t(_match, g1, g2, g3) => g1 + g2 + afterPrefix(g3)\n\t\t\t\t\t\t)\n\t\t\t\t\t\t.replace(\n\t\t\t\t\t\t\t/(?<=\\().+(?=:\\d+:\\d+\\))/g,\n\t\t\t\t\t\t\t(_match, g1, g2) => g1 + afterPrefix(g2)\n\t\t\t\t\t\t);\n\t\t\t// TODO: Support Safari\n\n\t\t\treturn res;\n\t\t}\n\t}),\n\tglobalProp: \"Error\",\n\tsupports: SupportEnum.nonstandard\n} as APIInterceptor;\n","import { proxyGetString } from \"$shared/stringProxy\";\n\nproxyGetString(\"File\", [\"webkitRelativePath\"]);\n\n// TODO: Finish all interecptors for functions that create new files\n\n// TODO: Proxy this\n/*\nFIXME: Don't use this interface\nFileSystemEntry = new Proxy(FileSystemEntry, {\n\tconstruct() {\n\t\tconst ret = target.construct(...arguments);\n\n\t\tconst toURL = ret.toURL;\n\t\tret.toURL = () => afterPrefix(toURL());\n\t},\n});\n*/\n","import { type APIInterceptor, SupportEnum } from \"$types/apiInterceptors\";\n\nimport { afterPrefix } from \"$shared/getProxyUrl\";\n\nexport default {\n\tproxifiedObj: Proxy.revocable(launchQueue.setConsumer, {\n\t\tapply(_target, _that, args) {\n\t\t\tconst [callback] = args;\n\n\t\t\t// Intercept the manifest\n\t\t\treturn (params: any) => {\n\t\t\t\tparams.targetUrl = afterPrefix(params.targetUrl);\n\n\t\t\t\tcallback(params);\n\t\t\t};\n\t\t}\n\t}),\n\tglobalProp: \"launchQueue.setConsumer\",\n\tsupports: SupportEnum.draft | SupportEnum.shippingChromium\n} as APIInterceptor;\n","// FIXME: I have no idea why when I make this a library it doesn't work in the unit test builds\nimport type {\n\tAPIInterceptor,\n\t// ExposedContextsEnum,\n\tproxifiedObjGeneratorContext\n} from \"../../../../types/apiInterceptors\";\n// biome-ignore lint/style/useEnumInitializers: <explanation>\nenum ExposedContextsEnum {\n\tdedicatedWorker,\n\tsharedWorker,\n\taudioWorklet,\n\tanimationWorklet,\n\tlayoutWorklet,\n\tsharedStorageWorklet,\n\tpaintWorklet,\n\tserviceWorker,\n\twindow\n}\n\nimport type JSRewriter from \"$src/sandboxers/JS/JSRewriter\";\n\n// These interceptors conceal `location` and accessing `location` from the window object. The window proxy is injected directly into the `this` that IIFE that AeroSandbox is powered by.\n\n// Init\n/*\nconst proxyNamespace = window[\"<proxyNamespace>\"];\nproxyNamespace.aeroGel = {};\nconst aeroGel = proxyNamespace.aeroGel;\naeroGel.fakeVars = {};\n\n\\/*\n// Scope Checking. This is for DPSC. TODO: Make DPSC configurable on AST parsing and only use it when in a block scope.\n$aero.check = val => (val === location ? $location : val);\n*\\/\n\naeroGel.fakeVarsStore = new Map<\n\tstring,\n\t{\n\t\tvalue: string;\n\t\tisConst: boolean;\n\t}\n>();\n\nconst fakeVarsEmulationGetter = {\n\tget(_target, prop) {\n\t\tif (aeroGel.fakeVarsStore.has(prop))\n\t\t\treturn aeroGel.fakeVarsStore.get(prop.value);\n\t\treturn undefined;\n\t}\n};\n\naeroGel.fakeVarsLet = new Proxy(aeroGel.fakeVars, {\n\t...fakeVarsEmulationGetter,\n\tset(_target, prop, value) {\n\t\taeroGel.fakeVarsStore.set(prop, {\n\t\t\tvalue\n\t\t});\n\t\treturn true;\n\t}\n});\naeroGel.fakeVarsConst = new Proxy(aeroGel.fakeVars, {\n\t...fakeVarsEmulationGetter,\n\tset(_target, prop, value) {\n\t\tif (!aeroGel.fakeVarsStore.has(prop)) {\n\t\t\taeroGel.fakeVarsStore.set(prop, {\n\t\t\t\tvalue,\n\t\t\t\tisConst: true\n\t\t\t});\n\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t}\n});\n*/\n\n// biome-ignore lint/suspicious/noExplicitAny: <explanation>\nlet fakeValueForProxyNamespace: any = null;\nconst windowProxyInterceptor: APIInterceptor = {\n\tproxifiedObj: (ctx: proxifiedObjGeneratorContext) => {\n\t\t// TODO: Don't reveal $aero\n\t\tif (\n\t\t\tObject.values(ctx.specialInterceptionFeatures).includes(\"aeroGel\")\n\t\t) {\n\t\t\t// Prevent detection by checking if the fakeWindow was inherited from the real window.\n\t\t\tconst winProto = Object.getPrototypeOf(window);\n\t\t\treturn new Proxy(window, {\n\t\t\t\tget(target, prop) {\n\t\t\t\t\tif (prop === \"__proto__\") return winProto;\n\t\t\t\t\tif (prop === \"location\")\n\t\t\t\t\t\treturn window[\"<proxyNamespace>\"].proxifiedLocation;\n\t\t\t\t\tif (typeof target[prop] === \"function\")\n\t\t\t\t\t\treturn target[prop].bind(window);\n\t\t\t\t\t// Don't allow access to the proxy namespace so emulate the property\n\t\t\t\t\tif (prop === \"<proxyNamespace>\") {\n\t\t\t\t\t\tif (fakeValueForProxyNamespace !== null)\n\t\t\t\t\t\t\treturn fakeValueForProxyNamespace;\n\t\t\t\t\t\treturn undefined;\n\t\t\t\t\t}\n\t\t\t\t\treturn target[prop];\n\t\t\t\t},\n\t\t\t\tset(target, prop, value) {\n\t\t\t\t\tif (prop === \"<proxyNamespace>\") {\n\t\t\t\t\t\tfakeValueForProxyNamespace = value;\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\t\t\t\t\treturn Reflect.set(target, prop, value);\n\t\t\t\t},\n\t\t\t\tgetPrototypeOf(_target) {\n\t\t\t\t\treturn () => winProto;\n\t\t\t\t},\n\t\t\t\t// Conceal the proxy namespace by preventing detection from the \"in\" operator\n\t\t\t\thas(target, key) {\n\t\t\t\t\treturn (\n\t\t\t\t\t\tkey !== \"<proxyNamespace>\" && Reflect.has(target, key)\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t},\n\tglobalProp: `[\"<proxyNamespace>\"].js.proxifiedWindow`,\n\texposedContexts: ExposedContextsEnum.window\n};\n\n// @ts-ignore\nconst wrapScript: JSRewriter.wrapScript = `[\"<proxyNamespace>\"].js.wrapScript`;\n\nconst evalInterceptors: APIInterceptor[] = [\n\t{\n\t\tproxifiedObj: Proxy.revocable(Function, {\n\t\t\tconstruct(target, args) {\n\t\t\t\tlet [func] = args;\n\n\t\t\t\tlet bak = \"\";\n\n\t\t\t\tif (typeof func === \"string\") {\n\t\t\t\t\tbak = func;\n\t\t\t\t\tfunc = wrapScript(func);\n\t\t\t\t} else if (\n\t\t\t\t\ttypeof func === \"function\" &&\n\t\t\t\t\t!(\n\t\t\t\t\t\tfunc.toString() !==\n\t\t\t\t\t\t`function ${func.name}() { [native code] }\"`\n\t\t\t\t\t)\n\t\t\t\t) {\n\t\t\t\t\tbak = func.toString();\n\t\t\t\t\tfunc = wrapScript(func.toString());\n\t\t\t\t}\n\n\t\t\t\targs[0] = func;\n\n\t\t\t\tconst inst = Reflect.construct(target, args);\n\n\t\t\t\t// Use Object.defined to conceal the getter\n\t\t\t\tinst.bak = bak;\n\n\t\t\t\t// Hide the changes from the site\n\t\t\t\tinst.toString = () => bak;\n\n\t\t\t\treturn inst;\n\t\t\t}\n\t\t}),\n\t\tglobalProp: \"Function\"\n\t},\n\t{\n\t\tproxifiedObj: Proxy.revocable(eval, {\n\t\t\tapply(target, that, args) {\n\t\t\t\targs[0] = wrapScript(args[0]);\n\n\t\t\t\treturn Reflect.apply(target, that, args);\n\t\t\t}\n\t\t}),\n\t\t// You can't rewrite eval in strict mode\n\t\tglobalProp: `[\"<proxyNamespace>\"].js.eval`\n\t}\n];\n\nconst locationConcealers: APIInterceptor[] = [\n\t{\n\t\tproxifiedObj: Proxy.revocable(Object.getOwnPropertyDescriptor, {\n\t\t\tapply(target, that, args) {\n\t\t\t\tlet [obj, prop] = args;\n\n\t\t\t\tif (obj === location || (obj === window && prop === \"location\"))\n\t\t\t\t\tobj = window[\"<proxyNamespace>\"].proxifiedLocation;\n\n\t\t\t\targs[0] = obj;\n\n\t\t\t\treturn Reflect.apply(target, that, args);\n\t\t\t}\n\t\t}),\n\t\tglobalProp: \"Object.getOwnPropertyDescriptor\",\n\t\texposedContexts: ExposedContextsEnum.window\n\t},\n\t{\n\t\tproxifiedObj: Proxy.revocable(Reflect.set, {\n\t\t\tapply(target, that, args) {\n\t\t\t\tlet [theTarget, prop, value] = args;\n\n\t\t\t\tif (theTarget === window)\n\t\t\t\t\t// @ts-ignore\n\t\t\t\t\ttheTarget = [\"<proxyNamespace>\"].js.proxifiedWindow;\n\t\t\t\tif (theTarget instanceof Location) {\n\t\t\t\t\twindow[\"<proxyNamespace>\"].proxifiedLocation[prop] = value;\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\treturn Reflect.apply(target, that, args);\n\t\t\t}\n\t\t}),\n\t\tglobalProp: \"Reflect.set\"\n\t},\n\t{\n\t\tproxifiedObj: Proxy.revocable(Reflect.get, {\n\t\t\tapply(target, that, args) {\n\t\t\t\tlet [theTarget, theProp] = args;\n\n\t\t\t\tif (theTarget === Window)\n\t\t\t\t\t// @ts-ignore\n\t\t\t\t\ttheTarget = [\"<proxyNamespace>\"].js.proxifiedWindow;\n\t\t\t\tif (theTarget instanceof Document)\n\t\t\t\t\tif (theProp === \"location\")\n\t\t\t\t\t\treturn window[\"<proxyNamespace>\"].proxifiedLocation;\n\t\t\t\tif (theTarget instanceof Location)\n\t\t\t\t\treturn window[\"<proxyNamespace>\"].proxifiedLocation;\n\t\t\t\t[theProp];\n\t\t\t\treturn Reflect.apply(target, that, args);\n\t\t\t}\n\t\t}),\n\t\tglobalProp: \"Reflect.get\"\n\t}\n];\n\nconst ProxyProxyInterceptor: APIInterceptor = {\n\t/**\n\t * Fixes `that` in the Proxy handlers being used to reveal the window if the target in the Proxy object is a property on the windowon\n\t * You could solve this issue with EST parsing, but that would make JS parsing way slower than it is now, so I opted to use the same window proxy object that AeroGel already uses\n\t * EST parsing is flawed compared to AeroGel because it is exponentially  `n` times more expensive to keep track of what will happen in the future, which would be a part of the solution for many UV's JS rewriting escapes. That is why the Discord bundle takes so long to rewrite using full-parse methods.\n\t */\n\tproxifiedObj: (ctx: proxifiedObjGeneratorContext) => {\n\t\tif (\n\t\t\tObject.values(ctx.specialInterceptionFeatures).includes(\"aeroGel\")\n\t\t) {\n\t\t\treturn new Proxy(Proxy, {\n\t\t\t\tconstruct(target, args) {\n\t\t\t\t\tlet [pTarget, handler] = args;\n\n\t\t\t\t\tif (\"apply\" in handler) {\n\t\t\t\t\t\tconst originalApplyHandler = handler.apply;\n\t\t\t\t\t\targs[1] = (_target, _that, pArgs) => {\n\t\t\t\t\t\t\t// _that is null\n\t\t\t\t\t\t\t// _target doesn't work\n\t\t\t\t\t\t\tconst pTargetBak = pTarget;\n\t\t\t\t\t\t\tpTarget = () => new Error().stack;\n\t\t\t\t\t\t\tconst revealingStackError = pTarget();\n\t\t\t\t\t\t\t// Restore functionality of the target method\n\t\t\t\t\t\t\tpTarget = pTargetBak;\n\t\t\t\t\t\t\t// Get the parents that contain the method\n\t\t\t\t\t\t\tconst targetName = pTarget.name;\n\t\t\t\t\t\t\tconst parentObjTree = [\n\t\t\t\t\t\t\t\t...revealingStackError.matchAll(\n\t\t\t\t\t\t\t\t\t/Error\\\\n\\s\\s\\s\\sat\\s([a-zA-Z.]*)/\n\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t][0].split(`.${targetName}`)[0];\n\t\t\t\t\t\t\tlet pThat = window[parentObjTree];\n\t\t\t\t\t\t\tif (pThat === window)\n\t\t\t\t\t\t\t\t// @ts-ignore\n\t\t\t\t\t\t\t\tpThat = windowProxyInterceptor.proxifiedObj;\n\t\t\t\t\t\t\treturn originalApplyHandler(pTarget, pThat, pArgs);\n\t\t\t\t\t\t};\n\t\t\t\t\t}\n\n\t\t\t\t\treturn Reflect.construct(target, args);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t},\n\tglobalProp: \"Proxy\",\n\tinsertLevel: 1\n};\nconst EventTargetInterceptor: APIInterceptor = {\n\t/**\n\t *  If you intercept `EventTarget.prototype.addEventListener` with a Proxy object to try to trap the window events, once a window event is triggered, `event.source` can be used to get the window object. This API interceptor solves that problem by setting `event.source` to the proxified object.\n\t */\n\tproxifiedObj: ctx =>\n\t\tnew Proxy(EventTarget.prototype.addEventListener, {\n\t\t\tapply(target, that, args) {\n\t\t\t\tconst [_eventName, handler] = args;\n\n\t\t\t\t// TODO: Use this same interceptor to implement catchall event interception to prevent using multiple proxies for API Interception\n\n\t\t\t\tif (\n\t\t\t\t\tObject.values(ctx.specialInterceptionFeatures).includes(\n\t\t\t\t\t\t\"aeroGel\"\n\t\t\t\t\t)\n\t\t\t\t) {\n\t\t\t\t\targs[1] = event => {\n\t\t\t\t\t\t// @ts-ignore\n\t\t\t\t\t\tevent.source = ProxyProxyInterceptor.proxifiedObj(ctx);\n\t\t\t\t\t\thandler(event);\n\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\treturn Reflect.apply(target, that, args);\n\t\t\t}\n\t\t}),\n\tglobalProp: \"EventTarget.prototype.addEventListener\"\n};\n\nexport {\n\tevalInterceptors,\n\tlocationConcealers,\n\twindowProxyInterceptor,\n\tProxyProxyInterceptor,\n\tEventTargetInterceptor\n};\n","import type { APIInterceptor } from \"$types/apiInterceptors\";\nimport { proxyLocation } from \"$shared/proxyLocation\";\n\n/**\n * Checks if a segment is a valid directory name.\n *\n * @param {string} segment - The segment to check.\n * @returns {boolean} Whether the segment is a valid directory name.\n */\nfunction isValidDirectoryName(segment: string): boolean {\n\treturn segment.match(/^[a-zA-Z0-9\\-_]+$/) !== null;\n}\n\n/**\n * Removes one level from the given path.\n * This function splits the path into segments, iterates over them in reverse order, and removes the first \"..\" segment it encounters that is followed by a segment that is not a valid directory name.\n *\n * @param - The path to modify.\n * @returns The modified path.\n *\n * @example let path = \"../../dir1/dir2;\n * let modifiedPath = removeOneLevel(path);\n * console.log(modifiedPath); // Outputs: \"../dir1/dir2\"\n */\nfunction removeOneLevel(path: string): string {\n\t// Split the path into segments\n\tconst segments = path.split(\"/\");\n\n\t// Iterate over the segments in reverse order\n\tfor (let i = segments.length - 1; i >= 0; i--) {\n\t\t// If the segment is \"..\" and the next segment is not a valid directory name\n\t\tif (\n\t\t\tsegments[i] === \"..\" &&\n\t\t\ti < segments.length - 1 &&\n\t\t\t!isValidDirectoryName(segments[i + 1])\n\t\t) {\n\t\t\t// Remove this segment\n\t\t\tsegments.splice(i, 1);\n\t\t\tbreak;\n\t\t}\n\t}\n\n\t// Join the segments back together into a path\n\tconst modifiedPath = segments.join(\"/\");\n\n\treturn modifiedPath;\n}\n\nexport default {\n\t// @ts-ignore\n\tproxifiedObj: Proxy.revocable(import.meta.resolve, {\n\t\tapply(target, that, args) {\n\t\t\tconst ret = Reflect.apply(target, that, args);\n\n\t\t\t// Prevent the paths from going behind the proxy origin\n\t\t\tlet curr = ret;\n\t\t\twhile (\n\t\t\t\t!new URL(curr, proxyLocation().href).href.startsWith(\n\t\t\t\t\tproxyLocation().href\n\t\t\t\t)\n\t\t\t) {\n\t\t\t\tcurr = removeOneLevel(curr);\n\t\t\t}\n\t\t\treturn curr;\n\t\t}\n\t}),\n\t// TODO: Define on $aero\n\tglobalProp: \"<proxyNamespace>.moduleScripts.resolve\"\n} as APIInterceptor;\n","// Not finished\n\nimport { afterPrefix } from \"$shared/getProxyUrl\";\n\nimport { proxyLocation } from \"$shared/proxyLocation\";\n\nimport { type APIInterceptor, SupportEnum } from \"$types/apiInterceptors\";\n\nexport default [\n\t// Entries\n\t// FIXME:\n\t{\n\t\tproxifiedObj: Proxy.revocable(navigation.entries, {\n\t\t\tapply(target, that, args) {\n\t\t\t\tconst entries: any[] = Reflect.apply(target, that, args);\n\n\t\t\t\t// We may delete some entries, so we will update the index with the new index\n\t\t\t\tlet i = 0;\n\n\t\t\t\tconst newEntries: any[] = [];\n\n\t\t\t\tfor (const entry of entries) {\n\t\t\t\t\tconst newEntry = entry;\n\n\t\t\t\t\t// The original property is a getter property, as the value will be changed dynamically\n\t\t\t\t\tObject.defineProperty(newEntry, \"url\", {\n\t\t\t\t\t\tget: () => entry.url.replace(afterPrefix, \"\")\n\t\t\t\t\t});\n\n\t\t\t\t\ttry {\n\t\t\t\t\t\tif (\n\t\t\t\t\t\t\tnew URL(newEntry.url).origin !==\n\t\t\t\t\t\t\tproxyLocation().origin\n\t\t\t\t\t\t)\n\t\t\t\t\t\t\t// The site is not supposed to see this entry\n\t\t\t\t\t\t\tcontinue;\n\t\t\t\t\t} catch {\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\n\t\t\t\t\tObject.defineProperty(newEntry, \"index\", {\n\t\t\t\t\t\tvalue: i++\n\t\t\t\t\t});\n\n\t\t\t\t\tnewEntries.push(newEntry);\n\t\t\t\t}\n\n\t\t\t\treturn newEntries;\n\t\t\t}\n\t\t}),\n\t\tglobalProp: \"navigation.entries\",\n\t\tsupports: SupportEnum.draft | SupportEnum.shippingChromium\n\t},\n\t{\n\t\tproxifiedObj: () => proxyLocation().href,\n\t\tglobalProp: \"navigation.transition.from\",\n\t\tsupports: SupportEnum.draft | SupportEnum.shippingChromium\n\t},\n\t{\n\t\tproxifiedObj: Proxy.revocable(navigation.addEventListener, {\n\t\t\tapply(target, that, args) {\n\t\t\t\tconst [messageType, listener] = args;\n\n\t\t\t\tif (messageType === \"currententrychange\")\n\t\t\t\t\targs[1] = (event: NavigationCurrentEntryChangeEvent) => {\n\t\t\t\t\t\tif (\"url\" in event.from)\n\t\t\t\t\t\t\tObject.defineProperty(event.from, \"url\", {\n\t\t\t\t\t\t\t\tget: () => afterPrefix(event.from.url),\n\t\t\t\t\t\t\t\tconfigurable: false\n\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\tevent.from.addEventListener = new Proxy(\n\t\t\t\t\t\t\tevent.from.addEventListener,\n\t\t\t\t\t\t\t// @ts-ignore\n\t\t\t\t\t\t\ti2.proxifiedObj\n\t\t\t\t\t\t);\n\n\t\t\t\t\t\tlistener(event);\n\t\t\t\t\t};\n\n\t\t\t\treturn Reflect.apply(target, that, args);\n\t\t\t}\n\t\t}),\n\t\tglobalProp: \"navigation.addEventListener\",\n\t\tsupports: SupportEnum.draft | SupportEnum.shippingChromium\n\t}\n] as APIInterceptor[];\n","import { type APIInterceptor, SupportEnum } from \"$types/apiInterceptors\";\n\nimport { proxyGetString } from \"$shared/stringProxy\";\n\nimport rewriteSrc from \"$shared/src\";\n\n// Only supported on Chromium\nexport default [\n\t{\n\t\tproxifiedObj: Proxy.revocable(PaymentRequest, {\n\t\t\tconstruct(target, prop, args) {\n\t\t\t\tconst [methods] = args;\n\n\t\t\t\targs[0] = methods.map(method => rewriteSrc(method));\n\n\t\t\t\treturn Reflect.construct(target, prop, args);\n\t\t\t}\n\t\t}),\n\t\tglobalProp: \"PaymentRequest\",\n\t\tsupports: SupportEnum.draft | SupportEnum.shippingChromium\n\t},\n\t{\n\t\tproxifiedObj: proxyGetString(\"MerchantValidationEvent\", [\n\t\t\t\"validationURL\"\n\t\t]),\n\t\tglobalProp: \"MerchantValidationEvent\",\n\t\tsupports:\n\t\t\tSupportEnum.deprecated |\n\t\t\tSupportEnum.draft |\n\t\t\tSupportEnum.shippingChromium\n\t}\n] as APIInterceptor[];\n","import { type APIInterceptor, SupportEnum } from \"$types/apiInterceptors\";\n\nimport { proxyGetString } from \"$shared/stringProxy\";\n\nimport rewriteSrc from \"$shared/src\";\n\nexport default [\n\t{\n\t\tproxifiedObj: Proxy.revocable(PresentationRequest, {\n\t\t\tconstruct(that, args) {\n\t\t\t\t// Could either be a string or an array\n\t\t\t\tlet [urls] = args;\n\n\t\t\t\tif (Array.isArray(urls))\n\t\t\t\t\turls = urls.map(url => rewriteSrc(url));\n\t\t\t\telse urls = rewriteSrc(urls);\n\n\t\t\t\targs[0] = urls;\n\n\t\t\t\treturn Reflect.construct(that, args);\n\t\t\t}\n\t\t}),\n\t\tglobalProp: \"PresentationRequest\",\n\t\tsupports: SupportEnum.draft | SupportEnum.shippingChromium\n\t},\n\t{\n\t\tproxifiedObj: proxyGetString(\"PresentationConnection\", [\"url\"]),\n\t\tglobalProp: \"PresentationConnection\",\n\t\tsupports: SupportEnum.draft | SupportEnum.shippingChromium\n\t}\n] as APIInterceptor[];\n","import {\n\ttype APIInterceptor,\n\tExposedContextsEnum\n} from \"$types/apiInterceptors\";\nimport { proxyGetString } from \"$shared/stringProxy\";\n\nexport default {\n\tproxifiedObj: proxyGetString(\"PushSubscription\", [\"endpoint\"]),\n\tglobalProp: \"PushSubscription\",\n\texposedContexts: ExposedContextsEnum.window\n} as APIInterceptor;\n","import { afterPrefix } from \"$shared/getProxyUrl\";\n\n// TODO: Define the undefined APIs on the Window object. This file is very incomplete.\n\n// Only supported on chromium\n/*\nif (\"ReportingObserver\" in window) {\n  async function rewriteReports(reports) {\n    for (let report of reports) {\n      // https://w3c.github.io/reporting/#serialize-reports\n      const json = report.toJSON();\n      report.toJSON = () => ({\n\t\t\t\t..on,\n        url: afterPrefix(json.url),\n      });\n\n      if (report instanceof CSPViolationReportBody) {\n        // Urls\n        CSPViolationReportBody.blockedURL = afterPrefix(\n          CSPViolationReportBody.blockedURL\n        );\n        CSPViolationReportBody.referrer = afterPrefix(\n          CSPViolationReportBody.referrer\n        );\n        CSPViolationReportBody.sourceFile = afterPrefix(\n          CSPViolationReportBody.sourceFile\n        );\n\n        // Don't reveal the rewrote script\n        const resp = await fetch(CSPViolationReportBody.sourceFile);\n        CSPViolationReportBody.sample = (await resp.text()).slice(\n          0,\n          resp.length\n        );\n      }\n\n      // Error location\n      report.sourceFile = afterPrefix(report.sourceFile);\n      // TODO: Get the column number from the line in the original script (through .lineNumber)\n      report.columnNumber = null;\n    }\n    return reports;\n  }\n\n  ReportingObserver = new Proxy(ReportingObserver, {\n    construct(target, args) {\n      const [callback] = args;\n\n      args[1] = async (reports) => {\n        reports = await rewriteReports(reports);\n\n        callback(...arguments);\n      };\n\n      const ret = Reflect.construct(target, args);\n\n      ret.takeRecords = async () => rewriteReports(ret.takeRecords());\n    },\n  });\n}\n*/\n","import {\n\ttype APIInterceptor,\n\tExposedContextsEnum\n} from \"$types/apiInterceptors\";\n\nimport { proxyLocation } from \"$shared/proxyLocation\";\n\nexport default {\n\tmodifyObjectProperty() {\n\t\tObject.defineProperty(window, \"isSecureContext\", {\n\t\t\tget: () =>\n\t\t\t\t//flags.emulateSecureContext ||\n\t\t\t\tproxyLocation().protocol === \"https:\"\n\t\t});\n\t},\n\tglobalProp: \"isSecureContext\",\n\texposedContexts: ExposedContextsEnum.window\n} as APIInterceptor;\n","import upToProxyLocation from \"sandbox/src/util/upToProxyLocation\";\n\n// FIXME:\n/*\nimport { prefix } from \"$src/config\";\n\nimport { afterPrefix } from \"$shared/afterPrefix\";\n\n/*\nThere are 3 ways to detect proxies using the Performance API\nUsing entry.name to expose the url\nIf the site was rewrote or the headers were modified, the size would be different than what is intended. You can think of this as a form of hash checking\nIf you make a request to two different proxy origins on the site that are both cached and one has the Clear-Site-Data clearing both proxy origins, the proxy can be detected\n*\\/\n\n// Private scope\n{\n\tconst resInfo = new Map();\n\n\tconst broadcast = new BroadcastChannel(\"resCached\");\n\n\t// Detect if cache is cached\n\t// TODO: Broadcast this info on the sw\n\tbroadcast.onmessage = event => {\n\t\tconst { url, cached } = event.data.payload;\n\n\t\tresInfo.add(url, cached);\n\t};\n\n\tfunction isCached(url) {\n\t\tlet res = resInfo.get(url);\n\n\t\treturn res ? url in res : false;\n\t}\n\n\tasync function getHeader(name) {\n\t\tconst resp = await fetch(url);\n\n\t\treturn resp.headers[name];\n\t}\n\n\tasync function getBodySize(url) {\n\t\treturn await getHeader(url, \"x-aero-size-body\");\n\t}\n\n\tperformance.getEntries = new Proxy(performance.getEntries, {\n\t\tapply(target, that, args) {\n\t\t\tlet entries: PerformanceEntryList = Reflect.apply(\n\t\t\t\ttarget,\n\t\t\t\tthat,\n\t\t\t\targs\n\t\t\t);\n\n\t\t\treturn (\n\t\t\t\tentries\n\t\t\t\t\t// Hide aero's injections\n\t\t\t\t\t.filter(\n\t\t\t\t\t\tentry =>\n\t\t\t\t\t\t\t!entry.name.startsWith(location.origin + prefix)\n\t\t\t\t\t)\n\t\t\t\t\t.map(async entry => {\n\t\t\t\t\t\tif (entry.name) {\n\t\t\t\t\t\t\tObject.defineProperty(entry, \"name\", {\n\t\t\t\t\t\t\t\tvalue: afterPrefix(entry.name),\n\t\t\t\t\t\t\t\twritable: false,\n\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\t// FIXME: Fix this\n\t\t\t\t\t\t\tconst size = target[prop];\n\n\t\t\t\t\t\t\tconst resCached = isCached(url);\n\t\t\t\t\t\t\tconst resCrossOrigin = !url.startsWith(\n\t\t\t\t\t\t\t\tupToProxyOrigin\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\tconst isZero =\n\t\t\t\t\t\t\t\tresCached ||\n\t\t\t\t\t\t\t\tresCrossOrigin ||\n\t\t\t\t\t\t\t\t\"timing\" in $aero.sec.headers;\n\n\t\t\t\t\t\t\tObject.defineProperty(entry, \"transferSize\", {\n\t\t\t\t\t\t\t\tvalue: isZero\n\t\t\t\t\t\t\t\t\t? 0\n\t\t\t\t\t\t\t\t\t: await getHeader(\n\t\t\t\t\t\t\t\t\t\t\turl,\n\t\t\t\t\t\t\t\t\t\t\t\"x-aero-size-transfer\"\n\t\t\t\t\t\t\t\t\t  ),\n\t\t\t\t\t\t\t\twritable: false,\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\tObject.defineProperty(entry, \"encodedBodySize\", {\n\t\t\t\t\t\t\t\tvalue: async () => {\n\t\t\t\t\t\t\t\t\tif (isZero) return 0;\n\n\t\t\t\t\t\t\t\t\tconst decodeSize = prop.decodedBodySize;\n\n\t\t\t\t\t\t\t\t\t// There is no encoding\n\t\t\t\t\t\t\t\t\tif (size === decodeSize)\n\t\t\t\t\t\t\t\t\t\treturn await getBodySize(url);\n\t\t\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t\t\t\treturn await getHeader(\n\t\t\t\t\t\t\t\t\t\t\turl,\n\t\t\t\t\t\t\t\t\t\t\t\"x-aero-size-encbody\"\n\t\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\twritable: false,\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\tObject.defineProperty(entry, \"decodedBodySize\", {\n\t\t\t\t\t\t\t\tvalue: async () => {\n\t\t\t\t\t\t\t\t\tif (isZero) return 0;\n\n\t\t\t\t\t\t\t\t\treturn await getBodySize(url);\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\twritable: false,\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn entry;\n\t\t\t\t\t})\n\t\t\t);\n\t\t},\n\t});\n}\n*/\n","// TODO: Determine if XML needs to be rewrote with XML linked documents, or if it is already handled in the mutation observer\n","import proxy from \"$shared/stringProxy\";\n\nimport { afterPrefix } from \"$shared/getProxyUrl\";\n\nimport { proxyLocation } from \"$shared/proxyLocation\";\n\nimport { storageKey } from \"$aero_browser/misc/storage\";\n\n// TODO: Adopt the new API Interceptor design\n// Sender\n// FIXME: Breaks on Google\n/*\npostMessage = new Proxy(postMessage, {\n\tapply(target, that, args) {\n\t\tlet [data, origin] = args;\n\n\t\tif (origin !== \"*\") {\n\t\t\targs[1] = \"*\";\n\n\t\t\tdata.origin = origin;\n\n\t\t\targs[0] = data;\n\t\t}\n\n\t\treturn Reflect.apply(target, that, args);\n\t},\n});\n*/\n\nfunction eventInterceptor(type: string, listener: Function) {\n\tif (type === \"message\" || type === \"messageerror\")\n\t\treturn event => {\n\t\t\tif (event instanceof MessageEvent)\n\t\t\t\tif (event.origin === proxyLocation().origin) {\n\t\t\t\t\tObject.defineProperty(event, \"origin\", {\n\t\t\t\t\t\tvalue: proxyLocation().origin,\n\t\t\t\t\t\twritable: false\n\t\t\t\t\t});\n\t\t\t\t\tlistener(event);\n\t\t\t\t}\n\t\t};\n\tif (type === \"storage\") {\n\t\treturn event => {\n\t\t\tif (event instanceof StorageEvent) {\n\t\t\t\tObject.defineProperty(event, \"url\", {\n\t\t\t\t\tvalue: afterPrefix(event.url),\n\t\t\t\t\twritable: false\n\t\t\t\t});\n\n\t\t\t\t// Ensure the event isn't a clear event\n\t\t\t\tif (event.key !== null) {\n\t\t\t\t\tconst proxyKey = storageKey(event.key);\n\n\t\t\t\t\tif (proxyKey !== null)\n\t\t\t\t\t\tObject.defineProperty(event, \"key\", {\n\t\t\t\t\t\t\tvalue: proxyKey,\n\t\t\t\t\t\t\twritable: false\n\t\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t\tlistener(event);\n\t\t};\n\t}\n\tif (type === \"hashchange\") {\n\t\treturn event => {\n\t\t\tif (event instanceof HashChangeEvent) {\n\t\t\t\tObject.defineProperty(event, \"newURL\", {\n\t\t\t\t\tvalue: afterPrefix(event.newURL),\n\t\t\t\t\twritable: false\n\t\t\t\t});\n\t\t\t\tObject.defineProperty(event, \"oldURL\", {\n\t\t\t\t\tvalue: afterPrefix(event.oldURL),\n\t\t\t\t\twritable: false\n\t\t\t\t});\n\t\t\t}\n\t\t\tlistener(event);\n\t\t};\n\t}\n\n\treturn listener;\n}\nfunction setHandler(type: string) {\n\tlet set;\n\tObject.defineProperty(window, `on${type}`, {\n\t\tset: listener => {\n\t\t\tset = eventInterceptor(type, listener);\n\t\t},\n\t\tget: () => set\n\t});\n}\n\nsetHandler(\"message\");\nsetHandler(\"messageerror\");\nsetHandler(\"storage\");\nsetHandler(\"hashchange\");\n\n// Reciever concealer\n// @ts-ignore\nproxy(\"addEventListener\", new Map(1, eventInterceptor));\n","// TODO: Implement\n","// navigator.share\n\n// TODO: Implement\n","import {\n\ttype APIInterceptor,\n\tExposedContextsEnum\n} from \"$types/apiInterceptors\";\n\nimport rewriteSrc from \"$shared/src\";\n\nimport { proxyLocation } from \"$src/interceptors/loc/location\";\n\nconst historyState = {\n\tapply(target: any, that: ProxyHandler<object>, args: any[]) {\n\t\tlet url = \"\";\n\t\tif (args.length > 2 && typeof args[2] === \"string\") {\n\t\t\turl = args[2];\n\t\t}\n\n\t\ttry {\n\t\t\tif (args.length > 2) {\n\t\t\t\targs[2] = rewriteSrc(url, proxyLocation().href);\n\t\t\t}\n\t\t\tif (args.length > 3) {\n\t\t\t\targs[3] = rewriteSrc(url, proxyLocation().href);\n\t\t\t}\n\t\t} catch (error) {\n\t\t\t$aero.error(\n\t\t\t\t\"An error occurred while intercepting the source in the History API interceptor: \",\n\t\t\t\terror\n\t\t\t);\n\t\t}\n\n\t\treturn Reflect.apply(target, that, args);\n\t}\n};\n\nexport default [\n\t{\n\t\tproxifiedObj: Proxy.revocable(history.pushState, historyState),\n\t\tglobalProp: \"history.pushState\",\n\t\texposedContexts: ExposedContextsEnum.window\n\t},\n\t{\n\t\tproxifiedObj: Proxy.revocable(history.replaceState, historyState),\n\t\tglobalProp: \"history.replaceState\",\n\t\texposedContexts: ExposedContextsEnum.window\n\t}\n] as APIInterceptor[];\n","import type { APIInterceptor } from \"$types/apiInterceptors\";\n\nimport { proxyLocation, upToProxyOrigin } from \"$shared/proxyLocation\";\n\n// Prevent detection by instanceof\nconst inheritedObject = {};\nReflect.setPrototypeOf(inheritedObject, Object.getPrototypeOf(location));\n\nconst wrap = (url: string) => $aero.config.prefix + url;\n// TODO: Set locationProxy as not writable and not configurable\n\nexport default {\n\tproxifiedObj: new Proxy(inheritedObject, {\n\t\tget(target, prop) {\n\t\t\tfunction internal() {\n\t\t\t\tif (typeof target[prop] === \"function\") {\n\t\t\t\t\t// @ts-ignore\n\t\t\t\t\t// biome-ignore lint/suspicious/noExplicitAny: <explanation>\n\t\t\t\t\tconst props: any = {\n\t\t\t\t\t\ttoString: () => proxyLocation().toString()\n\t\t\t\t\t};\n\n\t\t\t\t\t// These properties below are not defined in workers\n\t\t\t\t\tif (\"assign\" in location)\n\t\t\t\t\t\tprops.assign = (url: string) =>\n\t\t\t\t\t\t\tlocation.assign(wrap(url));\n\t\t\t\t\tif (\"replace\" in location)\n\t\t\t\t\t\tprops.replace = (url: string) =>\n\t\t\t\t\t\t\tlocation.replace(wrap(url));\n\n\t\t\t\t\treturn prop in props && prop in location\n\t\t\t\t\t\t? props[prop]\n\t\t\t\t\t\t: target[prop];\n\t\t\t\t}\n\n\t\t\t\tconst fakeUrl = proxyLocation;\n\n\t\t\t\t/**\n\t\t\t\t * `ancestorOrigins` is only found in Chrome\n\t\t\t\t */\n\t\t\t\tconst customProps = {\n\t\t\t\t\t// TODO: Rewrite\n\t\t\t\t\t//ancestorOrigins: location.ancestorOrigins,\n\t\t\t\t};\n\n\t\t\t\tif (prop in customProps) return customProps[prop];\n\n\t\t\t\tif (prop in fakeUrl) return fakeUrl[prop];\n\n\t\t\t\treturn location[prop];\n\t\t\t}\n\n\t\t\tconst ret = internal();\n\n\t\t\treturn ret;\n\t\t},\n\t\tset(target, prop, value) {\n\t\t\tif (\n\t\t\t\tprop === \"pathname\" ||\n\t\t\t\t(prop === \"href\" && value.startsWith(\"/\"))\n\t\t\t)\n\t\t\t\ttarget[prop] = upToProxyOrigin + value;\n\t\t\telse target[prop] = value;\n\n\t\t\treturn true;\n\t\t}\n\t}),\n\tglobalProp: `[\"<proxyNamespace>\"].proxifiedLocation`\n} as APIInterceptor;\n\n/*\nTODO: Make these proper API Interceptors\nObject.defineProperty(document, \"domain\", {\n\t// @ts-ignore\n\tget: () => locationProxy.hostname\n});\nObject.defineProperty(document, \"URL\", {\n\t// @ts-ignore\n\tget: () => locationProxy.href\n});\n*/\n","declare var $aero: AeroTypes.GlobalAeroCTX;\n\n/*\nimport rewriteSrc from \"$shared/src\";\n\nimport { proxyLocation } from \"$shared/proxyLocation\";\n\n\nNavigator.prototype.sendBeacon = new Proxy(Navigator.prototype.sendBeacon, {\n\tapply(target, that, args) {\n\t\tconst [url] = args;\n\n\t\targs[0] = rewriteSrc(url, proxyLocation().href);\n\n\t\treturn Reflect.apply(target, that, args);\n\t},\n});\n\n// Sandbox data to their respective origin\n{\n\tconst protoHandler = {\n\t\tapply(target, that, args) {\n\t\t\tconst [scheme, url] = args;\n\n\t\t\targs[0] = $aero.proto.set(scheme);\n\t\t\targs[1] = rewriteSrc(url, proxyLocation().href);\n\n\t\t\treturn Reflect.apply(target, that, args);\n\t\t},\n\t};\n\n\tnavigator.registerProtocolHandler = new Proxy(\n\t\tnavigator.registerProtocolHandler,\n\t\tprotoHandler\n\t);\n\tnavigator[\"unregisterProtocolHandler\"] = new Proxy(\n\t\tnavigator[\"unregisterProtocolHandler\"],\n\t\tprotoHandler\n\t);\n}\n{\n\tconst key = \"aero.badges\";\n\tconst item = localStorage.getItem(key);\n\n\tlet badges = item === null ? [] : JSON.parse(item) ?? [];\n\n\tlet badge;\n\n\tconst found = badges.find(\n\t\tbadge => badge.origin === proxyLocation().origin,\n\t\t(_el, i) => {\n\t\t\tbadge = badges[i];\n\t\t}\n\t);\n\n\tif (!found) {\n\t\tbadge = {\n\t\t\torigin: proxyLocation().origin,\n\t\t\ti: 0,\n\t\t};\n\n\t\tbadges.push(badge);\n\t}\n\n\tconst setBak = navigator.setAppBadge;\n\n\tfunction getTotal() {\n\t\tlet i = 0;\n\n\t\tfor (const badge of badges) i += badge.i;\n\n\t\treturn i;\n\t}\n\tfunction updateCount() {\n\t\tbadges.find(\n\t\t\tbadge => badge.origin === proxyLocation().origin,\n\t\t\t(_el, i) => {\n\t\t\t\t// Local\n\t\t\t\tbadges[i] = badge;\n\t\t\t\t// Update\n\t\t\t\tsetBak(getTotal());\n\t\t\t\t// Save\n\t\t\t\tlocalStorage.setItem(key, badge);\n\t\t\t}\n\t\t);\n\t}\n\n\tnavigator.setAppBadge = new Proxy(navigator.clearAppBadge, {\n\t\tapply(target, that, args) {\n\t\t\tconst [contents] = args;\n\n\t\t\tbadge.i = contents;\n\n\t\t\tupdateCount();\n\t\t},\n\t});\n\tnavigator.clearAppBadge = new Proxy(navigator.clearAppBadge, {\n\t\tapply() {\n\t\t\tbadge.i = 0;\n\n\t\t\tupdateCount();\n\t\t},\n\t});\n}\n*/\n","import {\n\ttype APIInterceptor,\n\tExposedContextsEnum\n} from \"$types/apiInterceptors\";\n\nimport rewriteSrc from \"$shared/src\";\n\nexport default {\n\tproxifiedApi: new Proxy(open, {\n\t\tapply(target, that, args) {\n\t\t\tconst [url] = args;\n\n\t\t\targs[0] = rewriteSrc(url);\n\n\t\t\treturn Reflect.apply(target, that, args);\n\t\t}\n\t}),\n\tglobalProp: \"open\",\n\texposedContexts: ExposedContextsEnum.window\n} as APIInterceptor;\n","// TODO: This is a WIP\n\n// biome-ignore lint/suspicious/noShadowRestrictedNames: <explanation>\nimport escape from \"$shared/escape\";\n\n/**\n * This whole file encompasses the {@link https://developer.mozilla.org/en-US/docs/Web/API/Web_Authentication_API WebAuthn}, {@link https://developer.mozilla.org/en-US/docs/Web/API/FedCM_API FedCM}, {@link https://wicg.github.io/web-otp WebOTP} APIs\n */\n\nimport {\n\ttype APIInterceptor,\n\tExposedContextsEnum\n} from \"$types/apiInterceptors\";\n\nimport { proxyLocation } from \"$shared/proxyLocation\";\nimport { afterPrefix } from \"$shared/getProxyUrl\";\nimport type BareClient from \"@mercuryworkshop/bare-mux\";\n\nconst credentialStore = new WeakMap<PasswordCredential, PasswordCredential>();\nconst publicKeyCredentialStore = new WeakMap<\n\tPublicKeyCredential,\n\tPublicKeyCredential\n>();\n\n// Credential Classes\n// From WebAuthn\nconst passwordCredential = new WeakMap<\n\tPasswordCredential,\n\tPasswordCredential\n>();\nconst federatedCredential = new WeakMap<\n\tFederatedCredential,\n\tFederatedCredential\n>();\nconst publicKeyCredential = new WeakMap<\n\tPublicKeyCredential,\n\tPublicKeyCredential\n>();\n// FedCM (draft)\nconst identityCredential = new WeakMap<\n\tIdentityCredential,\n\tIdentityCredential\n>();\nconst otpCredential = new WeakMap<OTPCredential, OTPCredential>();\n\n/** @see {@link https://w3c.github.io/webauthn/#dictdef-collectedclientdata} */\ninterface CollectedClientData {\n\treadonly type: string;\n\treadonly challenge: string;\n\treadonly origin: string;\n\treadonly topOrigin: string;\n\treadonly crossOrigin: boolean;\n}\n\nfunction proxifyCredentials(credentials: Credential): Credential {\n\tconst proxifiedCredentials: Credential = credentials;\n\n\t/**\n\t * @see {@link https://w3c.github.io/webappsec-credential-management/#credential-type-registry-credential-type CredentialTypeRegistry}\n\t * It seems as if MDN's resource for the credential types is not updated yet to reflect the FedCM Credential Types\n\t */\n\tswitch (credentials.type) {\n\t\t/**\n\t\t * @see {@link https://w3c.github.io/webappsec-credential-management/#federatedcredential-interface FederatedCredential}\n\t\t */\n\t\tcase \"federated\":\n\t\t\tbreak;\n\t\t/**\n\t\t * @see\n\t\t */\n\t\tcase \"identity\":\n\t\t\tbreak;\n\t\t/**\n\t\t * @see {@link https://wicg.github.io/web-otp/#otpcredential OTPCredential}\n\t\t */\n\t\tcase \"otp\":\n\t\t\t//\n\t\t\tconst otpCredentials = proxifiedCredentials as OTPCredential;\n\t\t\t// OTP doesn't need rewrites\n\n\t\t\tbreak;\n\t\t/**\n\t\t * @see {@link https://w3c.github.io/webappsec-credential-management/#passwordcredential-interface PasswordCredential}\n\t\t */\n\t\tcase \"password\":\n\t\t\tbreak;\n\t\t/**\n\t\t * @see {@link https://w3c.github.io/webauthn/#publickeycredential PublicKeyCredential}\n\t\t */\n\t\tcase \"public-key\":\n\t\t\tbreak;\n\t\tdefault:\n\t\t\t$aero.logger.fatalErr(\"FedCM\", \"Unknown credential type\");\n\t}\n\n\treturn proxifiedCredentials;\n}\n\nexport default [\n\t{\n\t\t// TODO: Support the rest of the navigator.credentials API - https://developer.mozilla.org/en-US/docs/Web/API/CredentialsContainer\n\t\tproxifiedObj: Proxy.revocable(navigator.credentials.store, {\n\t\t\tapply(target, that, args) {\n\t\t\t\tconst [credentialsObj] = args;\n\n\t\t\t\tconst proxifiedCredentialObj = {\n\t\t\t\t\tfederated: {\n\t\t\t\t\t\tid: escape(credentialsObj.id)\n\t\t\t\t\t},\n\t\t\t\t\t...credentialsObj\n\t\t\t\t};\n\n\t\t\t\t// @ts-ignore\n\t\t\t\tconst proxifiedCredentials = Reflect.construct(\n\t\t\t\t\ttarget,\n\t\t\t\t\tthat,\n\t\t\t\t\targs.shift().push(proxifiedCredentialObj)\n\t\t\t\t) as PasswordCredential;\n\t\t\t\t// @ts-ignore\n\t\t\t\tconst credentials = Reflect.construct(\n\t\t\t\t\ttarget,\n\t\t\t\t\tthat,\n\t\t\t\t\targs\n\t\t\t\t) as PasswordCredential;\n\n\t\t\t\t/*\n\t\t\t\tThere is no point of backing it up if it doesn't have what we need. We know it will error anyways\n\t\t\t\t*/\n\t\t\t\tif (\n\t\t\t\t\t\"federated\" in credentialsObj &&\n\t\t\t\t\t\"id\" in credentialsObj.federated\n\t\t\t\t)\n\t\t\t\t\tcredentialStore.set(proxifiedCredentials, credentials);\n\t\t\t}\n\t\t}),\n\t\tglobalProp: \"navigator.credentials\",\n\t\texposedContexts: ExposedContextsEnum.window\n\t},\n\t{\n\t\tproxifiedObj: Proxy.revocable(navigator.credentials.store, {\n\t\t\tapply(_target, _that, args) {\n\t\t\t\tconst credentialsObj: Credential = args[0];\n\n\t\t\t\targs[0] = proxifyCredentials(credentialsObj);\n\t\t\t}\n\t\t}),\n\t\tglobalProp: \"navigator.credentials.store\",\n\t\texposedContexts: ExposedContextsEnum.window\n\t},\n\t{\n\t\tproxifiedObj: Proxy.revocable(navigator.credentials.get, {\n\t\t\tapply(target, that, args) {\n\t\t\t\tconst options: CredentialRequestOptions = args[0];\n\n\t\t\t\tif (!options)\n\t\t\t\t\t// Return to normal operations and let the browser throw its proper exception\n\t\t\t\t\treturn Reflect.apply(target, that, args);\n\n\t\t\t\tconst newOptions = options;\n\n\t\t\t\t// https://w3c.github.io/webappsec-credential-management/#dictdef-federatedcredentialrequestoptions\n\t\t\t\tnewOptions.federated = {\n\t\t\t\t\t/*\n\t\t\t\t\tIt requires an origin; the path does not matter. The plan is to use passwords later on and do the escaping server-side on a [Bare Extended](https://github.com/tomphttp/specifications-v4/blob/master/optional-specs/BareExtended.md) endpoint to route to the correct identity provider. 😬\n\t\t\t\t\t@see {@link https://w3c.github.io/webappsec-credential-management/#provider-identification:~:text=the%20origin%20the%20provider%20uses%20for%20sign%20in}\n\t\t\t\t\t*/\n\t\t\t\t\tproviders: options.federated.providers.map(\n\t\t\t\t\t\t_provider => location.origin\n\t\t\t\t\t)\n\t\t\t\t};\n\n\t\t\t\tconst newArgs = args;\n\t\t\t\targs[0] = options;\n\n\t\t\t\tconst keyCredential = Reflect.apply(target, that, newArgs);\n\t\t\t\tif (keyCredential instanceof PublicKeyCredential) {\n\t\t\t\t\tconst proxifiedPublicKeyCredential: PublicKeyCredential = {\n\t\t\t\t\t\t...keyCredential\n\t\t\t\t\t};\n\n\t\t\t\t\t/**\n\t\t\t\t\t * @see {@link https://w3c.github.io/webauthn/#dom-authenticatorresponse-clientdatajson}\n\t\t\t\t\t * @see {@link https://w3c.github.io/webauthn/#dictdef-collectedclientdata}\n\t\t\t\t\t */\n\t\t\t\t\tconst clientData = JSON.parse(\n\t\t\t\t\t\tnew TextDecoder().decode(\n\t\t\t\t\t\t\tkeyCredential.response.clientDataJSON\n\t\t\t\t\t\t)\n\t\t\t\t\t) as CollectedClientData;\n\n\t\t\t\t\tconst proxifiedClientData = clientData;\n\n\t\t\t\t\tObject.defineProperties(proxifiedClientData, {\n\t\t\t\t\t\ttype: {\n\t\t\t\t\t\t\t// Make readonly\n\t\t\t\t\t\t\twritable: false,\n\t\t\t\t\t\t\tconfigurable: false\n\t\t\t\t\t\t},\n\t\t\t\t\t\torigin: {\n\t\t\t\t\t\t\t// @ts-ignore\n\t\t\t\t\t\t\tvalue: proxyLocation().origin,\n\t\t\t\t\t\t\t// Make readonly\n\t\t\t\t\t\t\twritable: false,\n\t\t\t\t\t\t\tconfigurable: false\n\t\t\t\t\t\t},\n\t\t\t\t\t\ttopOrigin: {\n\t\t\t\t\t\t\t// @ts-ignore\n\t\t\t\t\t\t\tvalue: proxyLocation({\n\t\t\t\t\t\t\t\t// Make this an actual option lol\n\t\t\t\t\t\t\t\ttopLevel: true\n\t\t\t\t\t\t\t}).origin,\n\t\t\t\t\t\t\t// Make readonly\n\t\t\t\t\t\t\twritable: false,\n\t\t\t\t\t\t\tconfigurable: false\n\t\t\t\t\t\t},\n\t\t\t\t\t\tcrossOrigin: {\n\t\t\t\t\t\t\t// @ts-ignore\n\t\t\t\t\t\t\tvalue:\n\t\t\t\t\t\t\t\tnew URL(afterPrefix(clientData.origin))\n\t\t\t\t\t\t\t\t\t.origin !== proxyLocation().origin,\n\t\t\t\t\t\t\t// Make readonly\n\t\t\t\t\t\t\twritable: false,\n\t\t\t\t\t\t\tconfigurable: false\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\n\t\t\t\t\tObject.defineProperty(\n\t\t\t\t\t\tproxifiedPublicKeyCredential.response,\n\t\t\t\t\t\t\"clientDataJSON\",\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t// @ts-ignore\n\t\t\t\t\t\t\tvalue: new TextEncoder().encode(\n\t\t\t\t\t\t\t\tJSON.stringify(proxifiedClientData)\n\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t// Make readonly\n\t\t\t\t\t\t\twritable: false,\n\t\t\t\t\t\t\tconfigurable: false\n\t\t\t\t\t\t}\n\t\t\t\t\t);\n\n\t\t\t\t\treturn proxifiedPublicKeyCredential;\n\t\t\t\t} else {\n\t\t\t\t\treturn keyCredential;\n\t\t\t\t}\n\t\t\t}\n\t\t}),\n\t\tglobalProp: \"navigator.credentials.get\",\n\t\texposedContexts: ExposedContextsEnum.window\n\t}\n\t// TODO: Support the rest of the Credential Management APIs - https://developer.mozilla.org/en-US/docs/Web/API/Credential_Management_API\n] as APIInterceptor[];\n","import {\n\ttype APIInterceptor,\n\tSpecialInterceptionFeaturesEnum\n} from \"$types/apiInterceptors\";\n\nimport { proxyConstructString } from \"$shared/stringProxy\";\n\nexport default {\n\tproxifiedObj: ctx => {\n\t\tif (\n\t\t\t\"requestUrlProxifier\" in ctx.specialInterceptionFeatures &&\n\t\t\tctx.specialInterceptionFeatures.requestUrlProxifier === true\n\t\t)\n\t\t\treturn proxyConstructString(\"EventSource\", [1]);\n\t\treturn;\n\t},\n\tglobalProp: \"EventSource\",\n\tspecialInterceptionFeatures:\n\t\tSpecialInterceptionFeaturesEnum.requestUrlProxifier\n} as APIInterceptor;\n","import {\n\ttype APIInterceptor,\n\tExposedContextsEnum\n} from \"$types/apiInterceptors\";\nimport { handleFetchEvent } from \"$aero_browser/util/swlessUtils\";\n\nexport default {\n\tproxifiedObj: Proxy.revocable(fetch, {\n\t\tapply(target, that, arg) {\n\t\t\tlet [, opts]: [any?, RequestInit?] = args;\n\t\t\topts ??= {};\n\n\t\t\topts =\n\t\t\t\targs[0] instanceof Request\n\t\t\t\t\t? {\n\t\t\t\t\t\t\t...args[0],\n\t\t\t\t\t\t\t...opts\n\t\t\t\t\t\t}\n\t\t\t\t\t: opts;\n\n\t\t\tconst headers: Record<string, string> = {};\n\n\t\t\tif (\n\t\t\t\topts.cache &&\n\t\t\t\t// only-if-cached requires the mode to be same origin\n\t\t\t\t!(\n\t\t\t\t\topts.mode !== \"same-origin\" &&\n\t\t\t\t\topts.cache === \"only-if-cached\"\n\t\t\t\t)\n\t\t\t) {\n\t\t\t\t// Emulate cache mode\n\t\t\t\tif (headers instanceof Headers)\n\t\t\t\t\theaders.append(\"x-aero-cache\", opts.cache);\n\t\t\t\telse headers[\"x-aero-cache\"] = opts.cache;\n\t\t\t}\n\n\t\t\tif ($aero.sandbox.swlessEnabled) {\n\t\t\t\tconst request = createRequest(opts, headers);\n\t\t\t\tconst nonDefaultResp = handleFetchEvent({ request });\n\t\t\t\tif (nonDefaultResp) return nonDefaultResp;\n\t\t\t}\n\n\t\t\treturn Reflect.apply(target, that, args).then((resp: Response) => {\n\t\t\t\tconst pass = resp.headers.get(\"x-headers\");\n\n\t\t\t\tif (pass !== null) resp.headers = new Headers(JSON.parse(pass));\n\n\t\t\t\t// Conceal the site's origin if it is revealed\n\t\t\t\tconst respUrl = new URL(resp.url);\n\t\t\t\tif (respUrl.origin === location.origin) return new Response();\n\n\t\t\t\treturn resp;\n\t\t\t});\n\t\t}\n\t}),\n\tglobalProp: \"fetch\",\n\texposedContexts: ExposedContextsEnum.window\n} as APIInterceptor;\n\nfunction createRequest(opts: RequestInit, headers: Record<string, string>) {\n\treturn new Request(opts, { headers });\n}\n","import {\n\tAltProtocolEnum,\n\ttype APIInterceptor,\n\tExposedContextsEnum\n} from \"$types/apiInterceptors\";\n\n// biome-ignore lint/suspicious/noShadowRestrictedNames: <explanation>\nimport escape from \"$shared/escape\";\n\nexport default {\n\tproxifiedObj: Proxy.revocable(RTCPeerConnection, {\n\t\tconstruct(target, args) {\n\t\t\tconst [config] = args;\n\n\t\t\t// Backup\n\t\t\tconst iceServersBak = config.iceServers;\n\n\t\t\tif (config.iceServers && config.wrtcBackends.length > 0) {\n\t\t\t\tconfig.iceServers = config.wrtcBackends;\n\t\t\t\targs[0] = config;\n\t\t\t}\n\n\t\t\tconst ret = new target(...args);\n\n\t\t\tret[\"_iceServers\"] = iceServersBak;\n\n\t\t\treturn ret;\n\t\t},\n\t\tget(target, prop) {\n\t\t\treturn typeof prop === \"string\" && escape(\"iceServers\").test(prop)\n\t\t\t\t? target[`_${prop}`]\n\t\t\t\t: Reflect.get(target, prop);\n\t\t},\n\t\tset(target, prop, value) {\n\t\t\tif (typeof prop === \"string\" && escape(\"iceServers\").test(prop)) {\n\t\t\t\ttarget[`_${prop}`] = value;\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\treturn Reflect.set(target, prop, value);\n\t\t}\n\t}),\n\tglobalProp: \"RTCPeerConnection\",\n\tforAltProtocol: AltProtocolEnum.webRTC,\n\texposedContexts: ExposedContextsEnum.window\n} as APIInterceptor;\n","import { AltProtocolEnum, type APIInterceptor } from \"$types/apiInterceptors\";\n\nimport { BareClient } from \"@mercuryworkshop/bare-mux\";\n\nimport rewriteSrc from \"$shared/src\";\n\n// TODO: (Percs) This file is incomplete\nconst client = new BareClient();\n\nexport default [\n\t{\n\t\tproxifiedObj: Proxy.revocable(WebSocket, {\n\t\t\tconstruct(target, args) {\n\t\t\t\treturn client.createWebSocket(\n\t\t\t\t\targs[0],\n\t\t\t\t\targs[1],\n\t\t\t\t\ttarget,\n\t\t\t\t\t{\n\t\t\t\t\t\t\"User-Agent\": navigator.userAgent\n\t\t\t\t\t},\n\t\t\t\t\tArrayBuffer.prototype\n\t\t\t\t);\n\t\t\t}\n\t\t}),\n\t\tforAltProtocol: AltProtocolEnum.webSockets,\n\t\tglobalProp: \"Websocket\"\n\t}\n] as APIInterceptor[];\n","import type { APIInterceptor } from \"$types/apiInterceptors\";\n\n// Only supported on Chromium\nexport default {\n\tproxifiedObj: Proxy.revocable(WebTransport, {\n\t\tconstruct(target, args) {\n\t\t\t// I'm waiting for the bare/wisp spec to support WebTransport before implementing this\n\t\t\treturn Reflect.construct(target, args);\n\t\t}\n\t}),\n\tglobalProp: \"WebTransport\"\n} as APIInterceptor;\n","import type { APIInterceptor } from \"$aero/types/apiInterceptors\";\n\nimport { proxyLocation, upToProxyOrigin } from \"$src/interceptors/loc/location\";\n\nimport { rewriteGetCookie, rewriteSetCookie } from \"$shared/hared/cookie\";\n\nfunction getOriginalCookie(cookie) {\n\t// Not done\n\treturn cookie;\n}\n\nlet apiInterceptors: APIInterceptor = [];\n\n// Get the types for the cookieStore API and import them in index.d.ts for us here\nif (\"cookieStore\" in window) {\n\tapiInterceptors.push({\n\t\tstorageProxifiedObj: cookieStoreId => {\n\t\t\treturn Proxy.revocable(cookieStore.set, {\n\t\t\t\tapply(target, that, args) {\n\t\t\t\t\tconst [cookie] = args;\n\n\t\t\t\t\t// TODO: Isolate contextual identity\n\n\t\t\t\t\tcookie.domain = proxyLocation().domain;\n\t\t\t\t\tcookie.path = upToProxyOrigin() + cookie.path;\n\n\t\t\t\t\targs[0] = cookie;\n\n\t\t\t\t\treturn Reflect.apply(target, that, args);\n\t\t\t\t}\n\t\t\t});\n\t\t},\n\t\tglobalProp: \"cookieStore.set\"\n\t});\n\t//cookieStore.set =\n\t/*\n\tcookieStore.get = new Proxy(cookieStore.set, {\n\t\tapply(target, that, args) {\n\t\t\treturn getOriginalCookie(\n\t\t\t\tprefix,\n\t\t\t\tReflect.apply(target, that, args)\n\t\t\t);\n\t\t},\n\t});\n\t*/\n\tcookieStore.addEventListener = new Proxy(cookieStore.addEventListener, {\n\t\tapply(target, that, args) {\n\t\t\tconst [type, listener] = args;\n\n\t\t\tif (type === \"change\")\n\t\t\t\targs[1] = event => {\n\t\t\t\t\tif (event instanceof CookieChangeEvent) {\n\t\t\t\t\t\t/*\n\t\t\t\t\t\tTODO: Rewrite\n\t\t\t\t\t\tevent.changed\n\t\t\t\t\t\tevent.deleted\n\t\t\t\t\t\t*/\n\t\t\t\t\t}\n\n\t\t\t\t\tevent.listener(event);\n\t\t\t\t};\n\n\t\t\treturn Reflect.apply(target, that, args);\n\t\t}\n\t});\n}\n\n{\n\tlet cookieBak = document.cookie;\n\tObject.defineProperty(document, \"cookie\", {\n\t\tget: () => rewriteGetCookie(cookieBak, proxyLocation()),\n\t\tset: value => (cookieBak = rewriteSetCookie(value, proxyLocation()))\n\t});\n}\n","// TODO: Make it so that any of the directory names inside of the file system APIs are escaped with ${PROXY_ORIGIN}/${ORIGINAL VALUE}\n\n/*\nFileSystemDirectoryHandle.prototype.getDirectory = new Proxy(\n\tFileSystemDirectoryHandle.prototype.getDirectory,\n\t{\n\t\tapply: () => {\n\t\t\treturn Reflect.apply(...arguments);\n\t\t\t// TODO: Implement this stub\n\t\t}\n\t}\n);\nFileSystemDirectoryHandle.prototype.setDirectory = new Proxy(\n\tFileSystemDirectoryHandle.prototype.setDirectory,\n\t{\n\t\tapply: () => {\n\t\t\treturn Reflect.apply(...arguments);\n\t\t\t// TODO: Implement this stub\n\t\t}\n\t}\n);\n*/\n","import type { APIInterceptor } from \"$types/apiInterceptors\";\n\nimport { storageNomenclature } from \"./shared\";\n\nexport default [\n\t{\n\t\tstorageProxifiedObj: cookieStoreId =>\n\t\t\tProxy.revocable(indexedDB.open, storageNomenclature(cookieStoreId)),\n\t\tglobalProp: \"indexedDB.open\"\n\t},\n\t{\n\t\tstorageProxifiedObj: cookieStoreId =>\n\t\t\tProxy.revocable(\n\t\t\t\tindexedDB.deleteDatabase,\n\t\t\t\tstorageNomenclature(cookieStoreId)\n\t\t\t),\n\t\tglobalProp: \"indexedDB.deleteDatabase\"\n\t},\n\t{\n\t\tstorageProxifiedObj: cookieStoreId =>\n\t\t\tProxy.revocable(indexedDB.databases, {\n\t\t\t\tasync apply(target, that, args) {\n\t\t\t\t\tconst dbs = (await Reflect.apply(\n\t\t\t\t\t\ttarget,\n\t\t\t\t\t\tthat,\n\t\t\t\t\t\targs\n\t\t\t\t\t)) as IDBDatabaseInfo[];\n\n\t\t\t\t\tdbs.map(db => {\n\t\t\t\t\t\tif (db instanceof Error) return db;\n\n\t\t\t\t\t\tlet newName = aeroConfig.prefix + db.name;\n\t\t\t\t\t\tif (newName) newName = `${cookieStoreId}_${newName}`;\n\t\t\t\t\t\tdb.name = newName;\n\n\t\t\t\t\t\treturn db;\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}),\n\t\tglobalProp: \"indexedDB.databases\"\n\t}\n] as APIInterceptor[];\n","import config from \"$aero/examples/config\";\nimport type { APIInterceptor } from \"$types/apiInterceptors\";\nconst { prefix } = config;\n\nimport { storageNomenclature } from \"./shared\";\n\n// TODO: Import types for the Shared Storage API\n// TODO: Proxify it with the new system\n/*\nif (flags.nonstandard && \"sharedStorage\" in window) {\n\t// @see {@link https://developer.mozilla.org/en-US/docs/Web/API/Shared_Storage_API}\n\t// @see {@link https://developers.google.com/privacy-sandbox/relevance/shared-storage}\n\twindow.sharedStorage = \n  }\n  */\n\nexport default [\n\t{\n\t\tproxifiedObj: Proxy.revocable(window.sharedStorage, {\n\t\t\tapply(target, that, args) {\n\t\t\t\t// TODO: Implement\n\t\t\t\treturn Reflect.apply(target, that, args);\n\t\t\t}\n\t\t}),\n\t\tglobalProp: \"sharedStorage\"\n\t}\n] as APIInterceptor[];\n","import { storageNomenclature } from \"./shared\";\n\n// TODO: Implement\n","/*\nimport config from \"$src/config\";\nconst { flags } = config;\n\nimport rewriteSrc from \"$shared/hared/src\";\n\nimport { proxyLocation } from \"$shared/proxyLocation\";\n\n\nif (flags.nestedWorkers)\n\tif (\"serviceWorker\" in navigator) {\n\t\t// FIXME: Somehow unregisters all service workers, and then reloads on https://radon.games\n\t\t// Patch\n\t\tObject.defineProperty(navigator, \"serviceWorker\", {\n\t\t\tget() {\n\t\t\t\treturn undefined;\n\t\t\t},\n\t\t});\n\n\t\t/*\n\t\t// This api is only exposed in secure contexts\n\t\tnavigator.serviceWorker.register = new Proxy(\n\t\t\tnavigator.serviceWorker.register,\n\t\t\t{\n\t\t\t\tapply(target, that, args) {\n\t\t\t\t\tconst [path, opts] = args;\n\n\t\t\t\t\targs[0] = `${rewriteSrc(path, proxyLocation().href)}?mod=${\n\t\t\t\t\t\topts.type === \"module\"\n\t\t\t\t\t}`;\n\n\t\t\t\t\t$aero.error(\n\t\t\t\t\t\t`Registering a nested service worker\\n${path} ➜ ${args[0]}`\n\t\t\t\t\t);\n\n\t\t\t\t\treturn Reflect.apply(target, that, args);\n\t\t\t\t},\n\t\t\t}\n\t\t);\n\n\t\tconst rewriteReg = reg =>\n\t\t\t// Don't let the site see the aero sw\n\t\t\t(reg.active.scriptURL = reg.active.scriptURL.match(\n\t\t\t\tnew RegExp(\n\t\t\t\t\t`(?<=${location.origin}${prefix}${proxyLocation().origin}).*`,\n\t\t\t\t\t\"g\"\n\t\t\t\t)\n\t\t\t)[0]);\n\n\t\tnavigator.serviceWorker.getRegistration = new Proxy(\n\t\t\tnavigator.serviceWorker.getRegistration,\n\t\t\t{\n\t\t\t\tapply: async target =>\n\t\t\t\t\t(await target()).map(reg => rewriteReg(reg)),\n\t\t\t}\n\t\t);\n\t\tnavigator.serviceWorker.getRegistrations = new Proxy(\n\t\t\tnavigator.serviceWorker.getRegistrations,\n\t\t\t{\n\t\t\t\tapply: async target => rewriteReg(await target()),\n\t\t\t}\n\t\t);\n\t\t*\\/\n\t}\n*/\n","import { proxyLocation } from \"$shared/proxyLocation\";\n\n/** Escapes a string with underscores. */\nexport default function (str: string, origin = \"\"): RegExp {\n\treturn RegExp(`^(?:${origin}_+)?${str}$`, \"g\");\n}\n\n/**\n * Escape a string with an origin in the prefix; useful for isolation.\n * @param origin Defaults to the current proxy origin.\n * */\nfunction escapeWithOrigin(\n\tstr: string,\n\torigin = proxyLocation().origin\n): string {\n\treturn `${origin}_${str}`;\n}\n\nexport { escapeWithOrigin };\n","import sharedConfig from \"./sharedConfig\";\n\n// These methods allow the API Interceptors to get the proxy URL from the real URL\n\n/*\nSeparate the prefix from the url to get the proxy url isolated\nThis is primarily used for concealers\n*/\nfunction afterPrefix(realURL: string) {\n\tself.logger.log(`${location.origin}${sharedConfig(\"prefix\")}`);\n\treturn realURL.replace(\n\t\tnew RegExp(`^(${location.origin}${sharedConfig(\"prefix\")})`, \"g\"),\n\t\t\"\"\n\t);\n}\n\nfunction afterOrigin(realURL: string) {\n\treturn realURL.replace(new RegExp(`^(${location.origin})`, \"g\"), \"\");\n}\n\nexport { afterPrefix, afterOrigin };\n","export default (type: string): boolean =>\n\ttype.startsWith(\"text/html\") || type.startsWith(\"application/xhtml+xml\");\n","import sharedConfig from \"./sharedConfig\";\n\nimport { afterPrefix } from \"./getProxyUrl\";\n\nconst proxyLocation = () => new URL(afterPrefix(location.href));\nconst upToProxyOrigin = () => sharedConfig(\"prefix\") + proxyLocation().origin;\n\nexport { proxyLocation, upToProxyOrigin };\n","export default (configProp: string) => {\n\treturn \"$aero\" in self ? self.$aero[configProp] : self.config[configProp];\n};\n","import sharedConfig from \"./sharedConfig\";\n\nimport { proxyLocation } from \"./proxyLocation\";\n\n/**\n * This should not be used for processed html attributes, rather rewriteSrcHtml\n * @param - The url to rewrite\n */\nfunction rewriteSrc(url: string, proxyHref = proxyLocation().href): string {\n\t// Protocol\n\tconst rewroteUrl = /^(https?:\\/\\/)/g.test(url)\n\t\t? sharedConfig(\"prefix\") + url\n\t\t: new URL(url, proxyHref).href;\n\n\treturn rewroteUrl;\n}\n\nexport default rewriteSrc;\n","import sharedConfig from \"./sharedConfig\";\n\nimport { afterPrefix } from \"./getProxyUrl\";\n\nfunction proxy(\n\tapi: string,\n\t// biome-ignore lint/complexity/noBannedTypes: <explanation>\n\tmapRewriteArgs?: Map<number, Function>,\n\t// biome-ignore lint/complexity/noBannedTypes: <explanation>\n\trewriteResult?: Function\n): ProxyHandler<object> {\n\tif (api in window)\n\t\treturn new Proxy(window[api], {\n\t\t\tapply(target, that, args) {\n\t\t\t\tif (mapRewriteArgs)\n\t\t\t\t\tfor (const [argNum, rewrite] of mapRewriteArgs.entries())\n\t\t\t\t\t\tif (rewrite) args[argNum] = rewrite(...args);\n\n\t\t\t\tlet ret = Reflect.apply(target, that, args);\n\n\t\t\t\tif (rewriteResult) ret = rewriteResult(ret, ...args);\n\n\t\t\t\treturn ret;\n\t\t\t}\n\t\t});\n}\n\nfunction proxyGet(\n\tapi: string,\n\t// biome-ignore lint/complexity/noBannedTypes: <explanation>\n\tmapReplaceProps: Map<string, Function>\n): ProxyHandler<object> {\n\tif (api in window)\n\t\treturn new Proxy(window[api], {\n\t\t\tget(target, theProp) {\n\t\t\t\tif (\n\t\t\t\t\ttypeof theProp === \"string\" &&\n\t\t\t\t\tmapReplaceProps.has(theProp)\n\t\t\t\t) {\n\t\t\t\t\tconst handler = mapReplaceProps.get(theProp);\n\t\t\t\t\tif (handler) return handler(theProp);\n\t\t\t\t}\n\n\t\t\t\treturn Reflect.get(target, theProp);\n\t\t\t}\n\t\t});\n}\n\nfunction proxyConstructString(\n\tapiName: string,\n\targNums?: number[],\n\tres?: boolean\n): ProxyHandler<object> {\n\tif (argNums) {\n\t\tconst map = new Map<number, (...args: string[]) => string>();\n\n\t\t// I forgot what this is for\n\t\tfor (const argNum of argNums)\n\t\t\tmap.set(argNum, () => {\n\t\t\t\treturn sharedConfig(\"prefix\") + arguments[argNum];\n\t\t\t});\n\n\t\treturn proxy(apiName, map);\n\t}\n\tif (res)\n\t\treturn proxy(apiName, undefined, (res: string) => afterPrefix(res));\n}\nfunction proxyGetString(\n\tapiName: string,\n\tprops: string[]\n): ProxyHandler<object> {\n\tconst map = new Map();\n\n\tfor (const prop of props) map.set(prop, afterPrefix);\n\n\treturn proxyGet(apiName, map);\n}\n\nexport default proxy;\nexport { proxyConstructString, proxyGetString };\n","const e=20,t=globalThis.fetch,s=globalThis.WebSocket,r=globalThis.Request,o=globalThis.Response,a=globalThis.SharedWorker,n=globalThis.localStorage,i=globalThis.navigator.serviceWorker,c={prototype:{send:s.prototype.send},CLOSED:s.CLOSED,CLOSING:s.CLOSING,CONNECTING:s.CONNECTING,OPEN:s.OPEN};async function h(){const e=(await self.clients.matchAll({type:\"window\",includeUncontrolled:!0})).map((async e=>{const t=await function(e){let t=new MessageChannel;return new Promise((s=>{e.postMessage({type:\"getPort\",port:t.port2},[t.port2]),t.port1.onmessage=e=>{s(e.data)}}))}(e);return await l(t),t})),t=Promise.race([Promise.any(e),new Promise(((e,t)=>setTimeout(t,1e3,new TypeError(\"timeout\"))))]);try{return await t}catch(e){if(e instanceof AggregateError)throw console.error(\"bare-mux: failed to get a bare-mux SharedWorker MessagePort as all clients returned an invalid MessagePort.\"),new Error(\"All clients returned an invalid MessagePort.\");return console.warn(\"bare-mux: failed to get a bare-mux SharedWorker MessagePort within 1s, retrying\"),await h()}}function l(e){const t=new MessageChannel,s=new Promise(((e,s)=>{t.port1.onmessage=t=>{\"pong\"===t.data.type&&e()},setTimeout(s,1500)}));return e.postMessage({message:{type:\"ping\"},port:t.port2},[t.port2]),s}function p(e,t){const s=new a(e,\"bare-mux-worker\");return t&&i.addEventListener(\"message\",(t=>{if(\"getPort\"===t.data.type&&t.data.port){console.debug(\"bare-mux: recieved request for port from sw\");const s=new a(e,\"bare-mux-worker\");t.data.port.postMessage(s.port,[s.port])}})),s.port}let d=null;function w(){if(null===d){const e=new MessageChannel,t=new ReadableStream;let s;try{e.port1.postMessage(t,[t]),s=!0}catch(e){s=!1}return d=s,s}return d}class u{constructor(e){this.channel=new BroadcastChannel(\"bare-mux\"),e instanceof MessagePort||e instanceof Promise?this.port=e:this.createChannel(e,!0)}createChannel(e,t){if(self.clients)this.port=h(),this.channel.onmessage=e=>{\"refreshPort\"===e.data.type&&(this.port=h())};else if(e&&a){if(!e.startsWith(\"/\")&&!e.includes(\"://\"))throw new Error(\"Invalid URL. Must be absolute or start at the root.\");this.port=p(e,t),console.debug(\"bare-mux: setting localStorage bare-mux-path to\",e),n[\"bare-mux-path\"]=e}else{if(!a)throw new Error(\"Unable to get a channel to the SharedWorker.\");{const e=n[\"bare-mux-path\"];if(console.debug(\"bare-mux: got localStorage bare-mux-path:\",e),!e)throw new Error(\"Unable to get bare-mux workerPath from localStorage.\");this.port=p(e,t)}}}async sendMessage(e,t){this.port instanceof Promise&&(this.port=await this.port);try{await l(this.port)}catch{return console.warn(\"bare-mux: Failed to get a ping response from the worker within 1.5s. Assuming port is dead.\"),this.createChannel(),await this.sendMessage(e,t)}const s=new MessageChannel,r=[s.port2,...t||[]],o=new Promise(((e,t)=>{s.port1.onmessage=s=>{const r=s.data;\"error\"===r.type?t(r.error):e(r)}}));return this.port.postMessage({message:e,port:s.port2},r),await o}}class g extends EventTarget{constructor(e,t=[],s,r,o){super(),this.protocols=[],this.readyState=c.CONNECTING,this.binaryType=\"blob\",this.onopen=null,this.onerror=null,this.onmessage=null,this.onclose=null,this.url=e.toString(),this.protocols=t;const a=e=>{this.readyState=c.OPEN,this.protocols=e,this.meta={headers:{\"sec-websocket-protocol\":e}};const t=new Event(\"open\");this.dispatchEvent(t),this.onopen&&this.onopen(t)},n=async e=>{\"string\"==typeof e||(\"byteLength\"in e?\"blob\"===this.binaryType?e=new Blob([e]):Object.setPrototypeOf(e,o):\"arrayBuffer\"in e&&\"arraybuffer\"===this.binaryType&&(e=await e.arrayBuffer(),Object.setPrototypeOf(e,o)));const t=new MessageEvent(\"message\",{data:e});this.dispatchEvent(t),this.onmessage&&this.onmessage(t)},i=(e,t)=>{this.readyState=c.CLOSED;const s=new CloseEvent(\"close\",{code:e,reason:t});this.dispatchEvent(s),this.onclose&&this.onclose(s)},h=()=>{this.readyState=c.CLOSED;const e=new Event(\"error\");this.dispatchEvent(e),this.onerror&&this.onerror(e)};this.channel=new MessageChannel,this.channel.port1.onmessage=e=>{\"open\"===e.data.type?a(e.data.args[0]):\"message\"===e.data.type?n(e.data.args[0]):\"close\"===e.data.type?i(e.data.args[0],e.data.args[1]):\"error\"===e.data.type&&h()},s.sendMessage({type:\"websocket\",websocket:{url:e.toString(),origin:origin,protocols:t,requestHeaders:r,channel:this.channel.port2}},[this.channel.port2])}send(...e){if(this.readyState===c.CONNECTING)throw new DOMException(\"Failed to execute 'send' on 'WebSocket': Still in CONNECTING state.\");let t=e[0];t.buffer&&(t=t.buffer.slice(t.byteOffset,t.byteOffset+t.byteLength)),this.channel.port1.postMessage({type:\"data\",data:t},t instanceof ArrayBuffer?[t]:[])}close(e,t){this.readyState=c.CLOSING,this.channel.port1.postMessage({type:\"close\",closeCode:e,closeReason:t})}get bufferedAmount(){return 0}get protocol(){return Array.isArray(this.protocols)?this.protocols[0]||\"\":this.protocols||\"\"}get extensions(){return\"\"}}function y(e,t,s){console.error(`error while processing '${s}': `,t),e.postMessage({type:\"error\",error:t})}g.prototype.CONNECTING=c.CONNECTING,g.prototype.OPEN=c.OPEN,g.prototype.CLOSING=c.CLOSING,g.prototype.CLOSED=c.CLOSED;function f(e){for(let t=0;t<e.length;t++){const s=e[t];if(!\"!#$%&'*+-.0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ^_`abcdefghijklmnopqrstuvwxyz|~\".includes(s))return!1}return!0}const b=[\"ws:\",\"wss:\"],m=[101,204,205,304],E=[301,302,303,307,308];class M{constructor(e){this.worker=new u(e)}async getTransport(){return(await this.worker.sendMessage({type:\"get\"})).name}async setTransport(e,t,s){await this.setManualTransport(`\\n\\t\\t\\tconst { default: BareTransport } = await import(\"${e}\");\\n\\t\\t\\treturn [BareTransport, \"${e}\"];\\n\\t\\t`,t,s)}async setManualTransport(e,t,s){if(\"bare-mux-remote\"===e)throw new Error(\"Use setRemoteTransport.\");await this.worker.sendMessage({type:\"set\",client:{function:e,args:t}},s)}async setRemoteTransport(e,t){const s=new MessageChannel;s.port1.onmessage=async t=>{const s=t.data.port,r=t.data.message;if(\"fetch\"===r.type)try{e.ready||await e.init(),await async function(e,t,s){const r=await s.request(new URL(e.fetch.remote),e.fetch.method,e.fetch.body,e.fetch.headers,null);if(!w()&&r.body instanceof ReadableStream){const e=new o(r.body);r.body=await e.arrayBuffer()}r.body instanceof ReadableStream||r.body instanceof ArrayBuffer?t.postMessage({type:\"fetch\",fetch:r},[r.body]):t.postMessage({type:\"fetch\",fetch:r})}(r,s,e)}catch(e){y(s,e,\"fetch\")}else if(\"websocket\"===r.type)try{e.ready||await e.init(),await async function(e,t,s){const[r,o]=s.connect(new URL(e.websocket.url),e.websocket.origin,e.websocket.protocols,e.websocket.requestHeaders,(t=>{e.websocket.channel.postMessage({type:\"open\",args:[t]})}),(t=>{t instanceof ArrayBuffer?e.websocket.channel.postMessage({type:\"message\",args:[t]},[t]):e.websocket.channel.postMessage({type:\"message\",args:[t]})}),((t,s)=>{e.websocket.channel.postMessage({type:\"close\",args:[t,s]})}),(t=>{e.websocket.channel.postMessage({type:\"error\",args:[t]})}));e.websocket.channel.onmessage=e=>{\"data\"===e.data.type?r(e.data.data):\"close\"===e.data.type&&o(e.data.closeCode,e.data.closeReason)},t.postMessage({type:\"websocket\"})}(r,s,e)}catch(e){y(s,e,\"websocket\")}},await this.worker.sendMessage({type:\"set\",client:{function:\"bare-mux-remote\",args:[s.port2,t]}},[s.port2])}getInnerPort(){return this.worker.port}}class C{constructor(e){this.worker=new u(e)}createWebSocket(e,t=[],r,o,a){try{e=new URL(e)}catch(t){throw new DOMException(`Faiiled to construct 'WebSocket': The URL '${e}' is invalid.`)}if(!b.includes(e.protocol))throw new DOMException(`Failed to construct 'WebSocket': The URL's scheme must be either 'ws' or 'wss'. '${e.protocol}' is not allowed.`);Array.isArray(t)||(t=[t]),t=t.map(String);for(const e of t)if(!f(e))throw new DOMException(`Failed to construct 'WebSocket': The subprotocol '${e}' is invalid.`);a=a||(r||s).constructor.constructor(\"return ArrayBuffer\")().prototype,(o=o||{}).Host=new URL(e).host,o.Pragma=\"no-cache\",o[\"Cache-Control\"]=\"no-cache\",o.Upgrade=\"websocket\",o.Connection=\"Upgrade\";return new g(e,t,this.worker,o,a)}async fetch(e,s){const a=new r(e,s),n=s?.headers||a.headers,i=n instanceof Headers?Object.fromEntries(n):n,c=a.body;let h=new URL(a.url);if(h.protocol.startsWith(\"blob:\")){const e=await t(h),s=new o(e.body,e);return s.rawHeaders=Object.fromEntries(e.headers),s.rawResponse=e,s}for(let e=0;;e++){\"host\"in i?i.host=h.host:i.Host=h.host;let t=(await this.worker.sendMessage({type:\"fetch\",fetch:{remote:h.toString(),method:a.method,headers:i,body:c||void 0}},c?[c]:[])).fetch,r=new o(m.includes(t.status)?void 0:t.body,{headers:new Headers(t.headers),status:t.status,statusText:t.statusText});r.rawHeaders=t.headers,r.rawResponse=new o(t.body),r.finalURL=h.toString();const n=s?.redirect||a.redirect;if(!E.includes(r.status))return r;switch(n){case\"follow\":{const t=r.headers.get(\"location\");if(20>e&&null!==t){h=new URL(t,h);continue}throw new TypeError(\"Failed to fetch\")}case\"error\":throw new TypeError(\"Failed to fetch\");case\"manual\":return r}}}}export{C as BareClient,M as BareMuxConnection,c as WebSocketFields,u as WorkerConnection,w as browserSupportsTransferringStreams,C as default,e as maxRedirects,f as validProtocol};\n//# sourceMappingURL=index.mjs.map\n","import type {\n\tAPIInterceptor,\n\tproxifiedObjType,\n\tproxifiedObjGeneratorContext\n} from \"../types\";\n\nimport type { htmlRewriterMode } from \"../types/rewriters/html\";\n\nimport { buildConfig } from \"./customBuilds/aero\";\nimport { buildConfig as buildConfigFrakenUV } from \"./customBuilds/frankenUV.inject.ts\";\n\nimport { config } from \"../src/config.ts\";\nimport { FeatureFlags } from \"./featureFlags\";\n\ndeclare const HTML_REWRITER_MODE: htmlRewriterMode;\n\nlet proxifiedObjGenCtx: proxifiedObjGeneratorContext = {\n\t...buildConfig.specialInterceptionFeatures\n};\n\nif (process.env.BUILD_UV_FRAKEN)\n\tproxifiedObjGenCtx = {\n\t\t...buildConfigFrakenUV.specialInterceptionFeatures\n\t};\n\nif (process.env.BUILD_WOMBAT_SHIM) {\n\t// TODO: Build\n}\n\ntype level = number;\nconst insertLater = new Map<level, proxifiedObjType>();\n\n// @ts-ignore TODO: Move this code to AeroSandbox\nconst ctx = import.meta.webpackContext(\"../src/interceptors\", {\n\tinclude: /\\.ts$/\n});\nfor (const fileName of ctx.keys()) {\n\tconsole.log(fileName);\n\tconst aI: APIInterceptor = ctx(fileName);\n\tif (aI.insertLevel && aI.insertLevel !== 0)\n\t\tinsertLater.set(aI.insertLevel, aI);\n\telse handleAI(aI);\n}\n\n// @ts-ignore\nconst sortedInsertObj = Object.entries(\n\tArray.from(insertLater.keys()).sort((a, b) => b[1] - a[1])\n) as {\n\t[key: string]: APIInterceptor;\n};\n\nfor (const aI of Object.values(sortedInsertObj)) {\n\thandleAI(aI);\n}\n\nfunction handleAI(aI: APIInterceptor): void {\n\tif (aI.exposedContexts) {\n\t\tif (Object.values(aI.exposedContexts).includes(\"window\")) {\n\t\t\t// @ts-ignore\n\t\t\tif (aI.proxifiedObj) {\n\t\t\t\tconst proxyObject = resolveProxifiedObj(\n\t\t\t\t\t// @ts-ignore\n\t\t\t\t\taI.proxifiedObj,\n\t\t\t\t\tproxifiedObjGenCtx\n\t\t\t\t);\n\n\t\t\t\twindow[aI.globalProp] = proxyObject;\n\t\t\t} // @ts-ignore\n\t\t\telse if (aI.proxifiedObjWorkerVersion) {\n\t\t\t\tObject.defineProperty(\n\t\t\t\t\twindow,\n\t\t\t\t\taI.globalProp,\n\t\t\t\t\taI.proxifiedObjWorkerVersion\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\t} else {\n\t\t// @ts-ignore\n\t\tif (aI.proxifiedObj) {\n\t\t\tconst proxyObject = resolveProxifiedObj(\n\t\t\t\t// @ts-ignore\n\t\t\t\taI.proxifiedObj,\n\t\t\t\tproxifiedObjGenCtx\n\t\t\t);\n\n\t\t\tself[aI.globalProp] = proxyObject;\n\t\t} // @ts-ignore\n\t\telse if (aI.proxifiedObjWorkerVersion) {\n\t\t\tObject.defineProperty(\n\t\t\t\tself,\n\t\t\t\taI.globalProp,\n\t\t\t\taI.proxifiedObjWorkerVersion\n\t\t\t);\n\t\t}\n\t}\n}\n\nfunction resolveProxifiedObj(\n\tproxifiedObj: proxifiedObjType,\n\tctx: proxifiedObjGeneratorContext\n): proxifiedObjType {\n\tlet proxyObject = {};\n\tif (typeof proxifiedObj === \"function\") proxyObject = proxifiedObj(ctx);\n\telse if (typeof proxifiedObj === \"object\") proxyObject = proxifiedObj;\n\treturn proxyObject;\n}\n\n// Run the HTML Interceptors as per the config\nconst supportedHTMLRewriterModes: string[] = JSON.parse(\n\t// @ts-ignore\n\tSUPPORTED_HTML_REWRITER_MODES\n);\n\nconst preferredMode = config.FeatureFlags.HTML_REWRITER_MODE;\nif (!supportedHTMLRewriterModes.includes(preferredMode)) {\n\tthrow new Error(\n\t\t`This build of AeroSandbox does not support ${preferredMode}`\n\t);\n}\n\n// TODO: Delete all privacy sandbox APIs until bare-extended is finished and do that under the feature flag `DELETE_UNUSED_APIS` and recommend it for security. It would also delete the fenced frame element.\n\nif (\n\tpreferredMode === \"mutation_observer\" ||\n\t(preferredMode === \"custom_elements\" &&\n\t\tconfig.FeatureFlags.CUSTOM_ELEMENTS_USE === \"mutation_observers\")\n)\n\timport(\"../src/sandboxers/HTML/adaptors/useMutationObservers.ts\");\nif (\n\tpreferredMode === \"domparser\" ||\n\t(preferredMode === \"custom_elements\" &&\n\t\tconfig.FeatureFlags.CUSTOM_ELEMENTS_USE === \"domparser\")\n)\n\timport(\"../src/sandboxers/HTML/adaptors/useDOMParser.ts\");\nif (\n\tpreferredMode === \"sw_parser\" ||\n\t(preferredMode === \"custom_elements\" &&\n\t\tconfig.FeatureFlags.CUSTOM_ELEMENTS_USE === \"sw_parser\")\n)\n\timport(\"../src/sandboxers/HTML/adaptors/useParser.ts\");\nif (preferredMode === \"custom_elements\")\n\timport(\"../src/sandboxers/HTML/adaptors/useCustomElements.ts\");\n"],"names":["AeroSandbox","fakeOrigin","apiIncludeBitwiseEnum","apiExcludeBitwiseEnum","rewriterModesBitwiseEnum","isWorker","proxyOrigin","_instance","defaultSWProxyFeatures","buildConfig","proxyConfig","self","config","specialInterceptionFeatures","fakeOriginSettings","defaultProxyFeatures","UVRewriterMembers","__uv$config","encodeUrl","decodeUrl","InterceptionFeaturesEnum","originEmulationFeatures","corsEmulation","cacheEmulation","privacySandbox","nestedSWs","miscOriginIsolators","messageIsolation","miscOriginConcealers","elementConcealment","errorConcealment","requestUrlProxifier","isHtml","proxifiedObj","Proxy","revocable","Blob","apply","target","that","args","_args","arr","opts","type","map","html","$aero","init","ret","Reflect","size","forEach","length","globalProp","afterPrefix","ExposedContextsEnum","getSheet","sheet","get","prop","href","parentStyleSheet","getProcessingInstructionSheet","processingInstruction","modifyObjectProperty","Object","defineProperty","document","Array","from","styleSheets","exposedContexts","window","SupportEnum","Error","construct","res","columnNumber","fileName","stack","navigator","userAgent","includes","match","exec","ver","Number","parseFloat","replace","RegExp","concat","_match","g1","g2","g3","split","line","location","origin","join","supports","nonstandard","proxyGetString","launchQueue","setConsumer","_target","_that","callback","params","targetUrl","draft","shippingChromium","fakeValueForProxyNamespace","windowProxyInterceptor","ctx","values","winProto","getPrototypeOf","proxifiedLocation","bind","undefined","set","value","has","key","wrapScript","evalInterceptors","Function","func","bak","toString","name","inst","eval","locationConcealers","getOwnPropertyDescriptor","obj","theTarget","js","proxifiedWindow","_instanceof","Location","theProp","Window","Document","ProxyProxyInterceptor","pTarget","handler","originalApplyHandler","pArgs","pTargetBak","revealingStackError","targetName","parentObjTree","matchAll","pThat","insertLevel","EventTargetInterceptor","EventTarget","prototype","addEventListener","_eventName","event","source","proxyLocation","isValidDirectoryName","segment","removeOneLevel","path","segments","i","splice","modifiedPath","resolve","curr","URL","startsWith","navigation","entries","newEntries","_iteratorError","entry","newEntry","url","push","messageType","listener","configurable","i2","rewriteSrc","PaymentRequest","methods","method","deprecated","PresentationRequest","urls","isArray","protocol","proxy","storageKey","eventInterceptor","MessageEvent","writable","StorageEvent","proxyKey","HashChangeEvent","newURL","oldURL","setHandler","Map","historyState","error","history","pushState","replaceState","upToProxyOrigin","inheritedObject","setPrototypeOf","wrap","prefix","internal","props","assign","fakeUrl","customProps","proxifiedApi","open","escape","credentialStore","WeakMap","publicKeyCredentialStore","passwordCredential","federatedCredential","publicKeyCredential","identityCredential","otpCredential","proxifyCredentials","credentials","proxifiedCredentials","otpCredentials","logger","fatalErr","store","credentialsObj","proxifiedCredentialObj","federated","id","shift","options","newOptions","providers","_provider","newArgs","keyCredential","PublicKeyCredential","proxifiedPublicKeyCredential","clientData","JSON","parse","TextDecoder","decode","response","clientDataJSON","proxifiedClientData","defineProperties","topOrigin","topLevel","crossOrigin","TextEncoder","encode","stringify","SpecialInterceptionFeaturesEnum","proxyConstructString","handleFetchEvent","fetch","arg","Request","headers","cache","mode","Headers","append","sandbox","swlessEnabled","request","createRequest","nonDefaultResp","then","resp","pass","respUrl","Response","AltProtocolEnum","RTCPeerConnection","iceServersBak","iceServers","wrtcBackends","test","forAltProtocol","webRTC","BareClient","client","WebSocket","createWebSocket","ArrayBuffer","webSockets","WebTransport","rewriteGetCookie","rewriteSetCookie","getOriginalCookie","cookie","apiInterceptors","storageProxifiedObj","cookieStoreId","cookieStore","domain","CookieChangeEvent","cookieBak","storageNomenclature","indexedDB","deleteDatabase","databases","dbs","db","newName","aeroConfig","sharedStorage","str","escapeWithOrigin","sharedConfig","realURL","log","afterOrigin","configProp","proxyHref","rewroteUrl","api","mapRewriteArgs","rewriteResult","argNum","rewrite","proxyGet","mapReplaceProps","apiName","argNums","buildConfigFrakenUV","proxifiedObjGenCtx","process","env","BUILD_UV_FRAKEN","BUILD_WOMBAT_SHIM","insertLater","webpackContext","include","keys","console","aI","handleAI","sortedInsertObj","sort","a","b","_iteratorError1","aI1","proxyObject","resolveProxifiedObj","proxifiedObjWorkerVersion","proxyObject1","supportedHTMLRewriterModes","SUPPORTED_HTML_REWRITER_MODES","preferredMode","FeatureFlags","HTML_REWRITER_MODE","CUSTOM_ELEMENTS_USE"],"mappings":"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"}