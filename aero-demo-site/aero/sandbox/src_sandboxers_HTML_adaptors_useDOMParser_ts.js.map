{"version":3,"file":"src_sandboxers_HTML_adaptors_useDOMParser_ts.js","sources":["webpack://aero-sandbox/./src/sandboxers/HTML/adaptors/useDOMParser.ts","webpack://aero-sandbox/./src/sandboxers/HTML/shared/rewriteElement.ts?9956"],"sourcesContent":["import rewriteElement from \"$sandbox/HTML/shared/rewriteElement\";\n\nexport default function (domText: string) {\n\tconst dom = new DOMParser().parseFromString(domText, \"text/html\");\n\tfor (const childNode of dom.childNodes)\n\t\tif (childNode instanceof HTMLElement) rewriteElement(childNode);\n\t// Convert back to string\n\treturn dom.documentElement.innerHTML;\n}\n","import htmlRules from \"./htmlRules\";\n\nimport rewriteSrc from \"$shared/src\";\nimport rewriteHtmlSrc from \"./htmlSrc\";\n\nconst afterRewrote = new WeakMap<Element, boolean>();\nconst elContainer = new WeakMap<Element, Element>();\n\nfunction set(el: Element, attr: string, val = \"\", backup = true): void {\n\t// Avoid rewriting the next time by marking it to not be rewrote\n\tif (afterRewrote.has(el)) {\n\t\tconst isAfterRewrote = afterRewrote.get(el);\n\t\tif (isAfterRewrote === true) {\n\t\t\tafterRewrote.set(el, false);\n\t\t\treturn;\n\t\t}\n\t}\n\tafterRewrote.set(el, true);\n\n\tconst elBak = el.cloneNode(true);\n\tif (elBak instanceof Element) {\n\t\tel.setAttribute(attr, val);\n\n\t\t// Backup element (for Element hooks)\n\t\tif (backup) elContainer.set(el, elBak);\n\t}\n\n\tif ($aero.config.featureFlags.HTML_REWRITER_TYPE === \"mutation_observer\") {\n\t\tObject.defineProperty(el, attr, {\n\t\t\t// @ts-ignore\n\t\t\tget: Object.getOwnPropertyDescriptors(elBak).get,\n\t\t\t// @ts-ignore\n\t\t\tset: Object.getOwnPropertyDescriptors(el).set\n\t\t});\n\t}\n}\n\nexport default function rewriteElement(\n\tel: Element | Element,\n\tattrName?: string\n): Element {\n\t// Don't exclusively rewrite attributes or check for already observed elements\n\tconst isNew = typeof attrName === \"undefined\";\n\n\t// Check if the element's classes are any from the ignore classes\n\tconst elClassList = Array.from(el.classList);\n\tfor (const elClass of elClassList)\n\t\tfor (const ignoreClass of $aero.config.rewriters.html.ignoreClasses)\n\t\t\tif (elClass === ignoreClass) return el;\n\n\tif (isNew && \"integrity\" in el && el.integrity !== \"\") {\n\t\t// @ts-ignore\n\t\tconst cloner = new Cloner(el);\n\n\t\tcloner.clone();\n\t\tcloner.cleanup();\n\t}\n\n\t// @ts-ignore\n\tfor (const [elForRule, htmlRule] of htmlRules.entries())\n\t\tif (\n\t\t\tel instanceof elForRule && htmlRule.mustBeNew\n\t\t\t\t? isNew\n\t\t\t\t: true && attrName in htmlRule.onAttrHandlers\n\t\t) {\n\t\t\tconst attrHandler = htmlRule.onAttrHandlers[attrName];\n\t\t\tif (attrHandler instanceof Function)\n\t\t\t\tset(el, attrName, attrHandler[attrName](el, attrName));\n\t\t\telse if (attrHandler === \"rewrite-src\")\n\t\t\t\tset(el, attrName, rewriteSrc(attrName));\n\t\t\telse if (attrHandler === \"rewrite-html-src\")\n\t\t\t\tset(el, attrName, rewriteHtmlSrc(el.getAttribute(attrName)));\n\t\t}\n\n\t// @ts-ignore\n\tif (typeof el.onload === \"string\")\n\t\t// @ts-ignore\n\t\tset(el, \"onload\", $aero.rewriters.js(el.getAttribute(\"onload\")));\n\t// @ts-ignore\n\tif (typeof el.error === \"string\")\n\t\t// @ts-ignore\n\t\tset(el, \"onerror\", $aero.rewriters.js(el.getAttribute(\"onload\")));\n}\n"],"names":["rewriteElement","domText","dom","DOMParser","parseFromString","_iteratorError","childNodes","childNode","_instanceof","HTMLElement","documentElement","innerHTML","htmlRules","rewriteSrc","rewriteHtmlSrc","afterRewrote","WeakMap","elContainer","set","el","attr","val","backup","has","isAfterRewrote","get","elBak","cloneNode","Element","setAttribute","$aero","config","featureFlags","HTML_REWRITER_TYPE","Object","defineProperty","getOwnPropertyDescriptors","attrName","isNew","elClassList","Array","from","classList","_iteratorError1","elClass","rewriters","html","ignoreClasses","ignoreClass","integrity","cloner","Cloner","clone","cleanup","_iteratorError2","entries","elForRule","htmlRule","mustBeNew","onAttrHandlers","attrHandler","Function","getAttribute","onload","js","error"],"mappings":"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"}