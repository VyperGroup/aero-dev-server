{"version":3,"file":"src_sandboxers_HTML_adaptors_useParser_ts.js","sources":["webpack://aero-sandbox/./src/sandboxers/HTML/adaptors/useParser.ts","webpack://aero-sandbox/./src/sandboxers/HTML/shared/rewriteElement.ts?9956*"],"sourcesContent":["import { parseDocument } from \"htmlparser2\";\n// This runs in the SW, so it must not use any custom import paths\nimport rewriteElement from \"../shared/rewriteElement\";\n\nexport default function (domText: string) {\n\tconst dom = parseDocument(domText);\n\tfor (const childNode of dom.childNodes) {\n\t\tif (childNode.type === \"tag\") {\n\t\t\t// Close enough for our use cases\n\t\t\t// @ts-ignore\n\t\t\trewriteElement(childNode);\n\t\t}\n\t}\n}\n","import htmlRules from \"./htmlRules\";\n\nimport rewriteSrc from \"$shared/src\";\nimport rewriteHtmlSrc from \"./htmlSrc\";\n\nconst afterRewrote = new WeakMap<Element, boolean>();\nconst elContainer = new WeakMap<Element, Element>();\n\nfunction set(el: Element, attr: string, val = \"\", backup = true): void {\n\t// Avoid rewriting the next time by marking it to not be rewrote\n\tif (afterRewrote.has(el)) {\n\t\tconst isAfterRewrote = afterRewrote.get(el);\n\t\tif (isAfterRewrote === true) {\n\t\t\tafterRewrote.set(el, false);\n\t\t\treturn;\n\t\t}\n\t}\n\tafterRewrote.set(el, true);\n\n\tconst elBak = el.cloneNode(true);\n\tif (elBak instanceof Element) {\n\t\tel.setAttribute(attr, val);\n\n\t\t// Backup element (for Element hooks)\n\t\tif (backup) elContainer.set(el, elBak);\n\t}\n\n\tif ($aero.config.featureFlags.HTML_REWRITER_TYPE === \"mutation_observer\") {\n\t\tObject.defineProperty(el, attr, {\n\t\t\t// @ts-ignore\n\t\t\tget: Object.getOwnPropertyDescriptors(elBak).get,\n\t\t\t// @ts-ignore\n\t\t\tset: Object.getOwnPropertyDescriptors(el).set\n\t\t});\n\t}\n}\n\nexport default function rewriteElement(\n\tel: Element | Element,\n\tattrName?: string\n): Element {\n\t// Don't exclusively rewrite attributes or check for already observed elements\n\tconst isNew = typeof attrName === \"undefined\";\n\n\t// Check if the element's classes are any from the ignore classes\n\tconst elClassList = Array.from(el.classList);\n\tfor (const elClass of elClassList)\n\t\tfor (const ignoreClass of $aero.config.rewriters.html.ignoreClasses)\n\t\t\tif (elClass === ignoreClass) return el;\n\n\tif (isNew && \"integrity\" in el && el.integrity !== \"\") {\n\t\t// @ts-ignore\n\t\tconst cloner = new Cloner(el);\n\n\t\tcloner.clone();\n\t\tcloner.cleanup();\n\t}\n\n\t// @ts-ignore\n\tfor (const [elForRule, htmlRule] of htmlRules.entries())\n\t\tif (\n\t\t\tel instanceof elForRule && htmlRule.mustBeNew\n\t\t\t\t? isNew\n\t\t\t\t: true && attrName in htmlRule.onAttrHandlers\n\t\t) {\n\t\t\tconst attrHandler = htmlRule.onAttrHandlers[attrName];\n\t\t\tif (attrHandler instanceof Function)\n\t\t\t\tset(el, attrName, attrHandler[attrName](el, attrName));\n\t\t\telse if (attrHandler === \"rewrite-src\")\n\t\t\t\tset(el, attrName, rewriteSrc(attrName));\n\t\t\telse if (attrHandler === \"rewrite-html-src\")\n\t\t\t\tset(el, attrName, rewriteHtmlSrc(el.getAttribute(attrName)));\n\t\t}\n\n\t// @ts-ignore\n\tif (typeof el.onload === \"string\")\n\t\t// @ts-ignore\n\t\tset(el, \"onload\", $aero.rewriters.js(el.getAttribute(\"onload\")));\n\t// @ts-ignore\n\tif (typeof el.error === \"string\")\n\t\t// @ts-ignore\n\t\tset(el, \"onerror\", $aero.rewriters.js(el.getAttribute(\"onload\")));\n}\n"],"names":["parseDocument","rewriteElement","domText","dom","_iteratorError","childNodes","childNode","type","htmlRules","rewriteSrc","rewriteHtmlSrc","afterRewrote","WeakMap","elContainer","set","el","attr","val","backup","has","isAfterRewrote","get","elBak","cloneNode","_instanceof","Element","setAttribute","$aero","config","featureFlags","HTML_REWRITER_TYPE","Object","defineProperty","getOwnPropertyDescriptors","attrName","isNew","elClassList","Array","from","classList","_iteratorError1","elClass","rewriters","html","ignoreClasses","ignoreClass","integrity","cloner","Cloner","clone","cleanup","_iteratorError2","entries","elForRule","htmlRule","mustBeNew","onAttrHandlers","attrHandler","Function","getAttribute","onload","js","error"],"mappings":"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"}